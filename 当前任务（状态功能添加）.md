## 前置功能添加：

攻击者会在战斗界面右下方的战场总览中选择生物作为攻击目标，我希望在列表中的每个生物的名字后面加上

如果选中的动作是攻击检定的动作（最终的显示要么是什么都没有，要么是绿色的优势两字，要么是红色的劣势两字，要么是红色的 无法选中 四字）：
 1. 如果当前生物也就是攻击者攻击该生物是优势，那么就写上绿色的优势两字.
 2. 如果当前生物也就是攻击者攻击该生物是劣势，那么就写上红色的劣势两字.
 3. 如果没有优势或者没有劣势或者优势劣势都有，那就什么都没有。
 4. 如果当前生物中了对应生物的魅惑，那么就写上红色的 无法选中 四字。
 5. 攻击检定的优势和劣势无法叠加， 只要同时存在任意来源的优势与任意来源的劣势，就直接互相抵消为普通， **不比较数量**；无法选中的优先级高于优势和劣势，也就是说当前生物对一个无法选中生物的攻击即使有优势也不行。

如果选中的动作是豁免检定的动作（最终的显示要么是什么都没有，要么就是绿色的“豁免自动失败”）：
1. 如果当前生物选择了力量或者敏捷的豁免检定的动作，那就在中了麻痹/石化/昏迷的生物名字后方加上绿色的“豁免自动失败”


此外的重要功能有：
1. 所有状态会在战斗界面的上方先攻序列中给每个生物标记该状态以及状态持续回合。
2. 由状态所导致的被攻击的优势劣势、攻击的优势劣势、持续伤害、速度衰减、失能
3. 优势和劣势无法叠加，但是优势和劣势可以互相抵消变成无。
4. 某个生物如果有某个状态的话会在战斗界面上方的先攻序列中整呈现，我要新加一个功能就是当鼠标点击这个对应的状态上要弹出一个状态介绍窗口，里面有对这个状态的核心效果介绍，也就是下方表格里的“核心效果 (Key Effects)”（注意里面的文字内容除了力竭以外都可以原封不动地加进去，但是UI不能过于简陋，1-6的力竭的效果介绍就都把最后的 力竭表格 放上去）
5. 由于一部分的状态只有一个标签或者没法用程序完全实现，所以标签（战斗界面上方先攻序列中）需要有特别的UI（状态的边框的颜色变为主题中的红色）来提示DM该状态不能靠程序完全是自动化。

这里的攻击（攻击检定的动作）的优势和劣势并非是计算出来后就无法改变的，如果DM在战斗界面左下方的当前生物里选中该动作并对该攻击模式强制改变为优势、劣势或者无的话就依照DM的操作，也就是说左下方的攻击设置的优先级高于系统自动计算的优先级。

---

| 状态 (Condition)         | 核心效果 (Key Effects)                                                                                     | 具体实现的逻辑（实际需要实现的功能，省去的部分不用管）                                                                                                                                                                                                                                                                                           |
| :--------------------- | :----------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **目盲 (Blinded)**       | 无法视物；<br> 依赖视觉的属性检定自动失败；<br> 针对你的攻击检定具有优势；<br> 你的攻击检定具有劣势；                                             | 针对持有该状态的生物的攻击检定具有优势；攻击检定具有劣势（由程序自动在攻击时计算） ；<br>标签需红色边框提示DM                                                                                                                                                                                                                                                            |
| **魅惑 (Charmed)**       | 无法攻击魅惑者或以有害能力/魔法效应指定魅惑者；<br> 魅惑者对你进行的任何社交互动检定具有优势；                                                     | 魅惑很特殊，魅惑是唯一一个需要在代码里配置状态施展源头的一个状态。<br>如果生物A（可以不止一个被魅惑）被生物B所魅惑，那生物A在使用任何攻击检定的动作（豁免检定不受魅惑影响）的时候都不可以在页面右下方的战场总览中选中生物B（如果生物B被点击的话不会选中而是弹出一个"不能将攻击检定的动作的攻击目标定为魅惑源头"的提示框）；<br>标签需红色边框提示DM<br>这里面的逻辑非常复杂，你必须要好好计划代码要如何实现。                                                                                                     |
| **耳聋 (Deafened)**      | 无法听见；<br> 依赖听觉的属性检定自动失败；                                                                               | 由于本工具不需要管战斗之外的鉴定，所以耳聋就仅仅只是一个状态标签而已；<br>标签需红色边框提示DM                                                                                                                                                                                                                                                                    |
| **恐慌 (Frightened)**    | 当恐惧源在视线内时，属性检定和攻击检定具有劣势；<br>不能主动靠近恐惧源 。                                                                | 当有恐惧状态的生物进行攻击检定的攻击时先不要直接开始计算是否命中，而是弹出一个窗口让DM选择是否恐惧原在视线内，如果是那么攻击检定具有劣势，如果否那么正常计算；<br>标签需红色边框提示DM                                                                                                                                                                                                                       |
| **擒抱 (Grappled)**      | 速度降为0，且无法从任何速度加值中获益 。                                                                                  | 由于本工具没有实际的地图功能，所以擒抱就仅仅只是一个状态标签而已；<br>标签需红色边框提示DM                                                                                                                                                                                                                                                                      |
| **失能 (Incapacitated)** | 无法执行动作或反应 。                                                                                            | 该生物无法行动或反应，代码上可以复用刚刚加进来的生物只能被攻击不能攻击的那部分代码（就是中途加入的生物在上方先攻序列里的生物卡片会变灰和只能被攻击无法执行动作或反应的那部分代码）                                                                                                                                                                                                                             |
| **隐形 (Invisible)**     | 在没有魔法或特殊感官辅助的情况下无法被看见；<br>被视为处于重度遮蔽区域；<br>针对你的攻击检定具有劣势；<br>你的攻击检定具有优势 。                                | 针对持有该状态的生物的攻击检定具有劣势；攻击检定具有优势（由程序自动在攻击时计算） 。豁免检定不受影响；<br>标签需红色边框提示DM<br>                                                                                                                                                                                                                                               |
| **麻痹 (Paralyzed)**     | 处于失能状态，无法移动或说话；<br>力量和敏捷豁免自动失败；<br>针对你的攻击检定具有优势；<br>5尺内的攻击者若命中则为重击 。                                   | 有和失能一模一样的效果；<br>针对有麻痹状态的生物的攻击检定具有优势；<br>如果对麻痹生物的攻击检定攻击命中了，需要在计算伤害前先弹出一个窗口让DM选择是否 5尺内 的窗口，如果DM选是那就换成重击，选不是就正常计算伤害（注意这个弹窗不应该在"选择目标"时弹出，而应该在"确认命中，点击造成伤害"的那一瞬间弹出，也就是"命中后，计算伤害前"）；<br>当有麻痹状态的目标被选中为豁免检定的动作的攻击目标时有两种情况：<br>1需要力量和敏捷豁免的话自动失败<br>2其余的豁免检定的动作不受影响；<br>在列表中的每个有该状态的生物的名字后面加上显示"5尺内重击"的绿色特殊标注（由于对攻击者是可能的好处）<br> |
| **石化 (Petrified)**     | 变为固态无机物；<br> 处于失能状态，无法移动、说话且对周围环境无感知；<br> 力量和敏捷豁免自动失败；<br> 针对你的攻击检定具有优势；<br> 获得对所有伤害的抗性；<br> 免疫毒素和疾病 。 | 有和失能一模一样的效果；<br>针对有石化状态的生物的攻击检定具有优势；<br>当有石化状态的目标被选中为豁免检定的动作的攻击目标时有两种情况：<br>1需要力量和敏捷豁免的话自动失败<br>2其余的豁免检定的动作不受影响；<br>获得对所有伤害的抗性；<br>免疫毒素和疾病；<br>在列表中的每个有该状态的生物的名字后面加上显示"全抗性+免毒"的红色特殊标注（由于对攻击者是坏处）<br>                                                                                                                  |
| **中毒 (Poisoned)**      | 攻击检定和属性检定具有劣势。                                                                                         | 攻击检定具有劣势                                                                                                                                                                                                                                                                                                              |
| **倒地 (Prone)**         | 唯一的移动选项是爬行；<br>攻击检定具有劣势；<br>5尺内的攻击者对你的攻击检定具有优势，超过5尺的攻击者则具有劣势 。                                         | 倒地生物的攻击检定攻击对所有生物具有劣势；<br>如果对倒地生物进行了攻击检定攻击，需要在计算是否命中前先弹出一个窗口让DM选择是否 5尺内 的窗口，如果DM选是那攻击检定具有优势，选不是就攻击检定具有劣势；<br>在列表中的每个有该状态的生物的名字后面加上显示"5尺优势/远程劣势"的白色特殊标注（由于对攻击者来说既有好处又有坏处，所以选白色）<br>                                                                                                                                     |
| **束缚 (Restrained)**    | 速度降为0；<br>针对你的攻击检定具有优势，你的攻击检定具有劣势；<br>敏捷豁免具有劣势 。                                                       | 针对有束缚状态的生物的攻击检定具有优势，有束缚状态的生物的攻击检定具有劣势；<br>标签需红色边框提示DM                                                                                                                                                                                                                                                                 |
| **震慑 (Stunned)**       | 处于失能状态，无法移动，只能结巴地说话；<br>力量和敏捷豁免自动失败；<br>针对你的攻击检定具有优势 。                                                 | 有和失能一模一样的效果；<br>针对有震慑状态的生物的攻击检定具有优势；<br>当有震慑状态的目标被选中为豁免检定的动作的攻击目标时有两种情况：<br>1需要力量和敏捷豁免的话自动失败<br>2其余的豁免检定的动作不受影响；                                                                                                                                                                                                      |
| **昏迷 (Unconscious)**   | 处于失能状态，无法移动、说话且对周围环境无感知；<br>丢下手中物品并倒地；<br>力量和敏捷豁免自动失败；<br>针对你的攻击检定具有优势；<br>5尺内的攻击者若命中则为重击              | 和麻痹一模一样                                                                                                                                                                                                                                                                                                               |
| **力竭 1级**              | 属性检定具有劣势                                                                                               | 由于本工具不需要管战斗之外的属性检定，所以力竭1级就仅仅只是一个状态标签而已；<br>标签需红色边框提示DM                                                                                                                                                                                                                                                                |
| **力竭 2级**              | 【累积1级效果】<br>属性检定具有劣势；<br>速度减半                                                                          | 由于本工具没有实际的地图功能，所以力竭2级就仅仅只是一个状态标签而已；<br>标签需红色边框提示DM                                                                                                                                                                                                                                                                    |
| **力竭 3级**              | 【累积1-2级效果】<br>属性检定具有劣势；<br>速度减半；<br>攻击检定和豁免检定具有劣势                                                      | 攻击检定具有劣势（由程序自动在攻击时计算）；<br>豁免检定具有劣势（当该生物作为豁免检定动作的目标时，掷豁免骰以劣势进行，由程序自动计算）；<br>标签需红色边框提示DM                                                                                                                                                                                                                                |
| **力竭 4级**              | 【累积1-3级效果】<br>属性检定具有劣势；<br>速度减半；<br>攻击检定和豁免检定具有劣势；<br>生命值上限减半                                          | 有和力竭3级一样的自动化效果；<br>生命值上限减半：当该生物获得力竭4级时，自动将其生命值上限设为原上限的50%（向下取整），若当前HP超过新上限则降至新上限；<br>当力竭等级降至3级或以下时，恢复原生命值上限（但当前HP不变）；<br>标签需红色边框提示DM                                                                                                                                                                                  |
| **力竭 5级**              | 【累积1-4级效果】<br>属性检定具有劣势；<br>速度减半；<br>攻击检定和豁免检定具有劣势；<br>生命值上限减半；<br>速度降为0                                | 有和力竭4级一样的自动化效果；<br>由于本工具没有实际的地图功能，速度降为0仅作为标签提示；<br>标签需红色边框提示DM                                                                                                                                                                                                                                                        |
| **力竭 6级**              | 【累积1-5级效果】<br>属性检定具有劣势；<br>速度减半；<br>攻击检定和豁免检定具有劣势；<br>生命值上限减半；<br>速度降为0；<br>**死亡**                     | 当该生物的力竭等级达到6级时：<br>1. 弹出确认窗口："[生物名]因力竭6级而死亡，是否确认？"<br>2. 确认后该生物立即死亡（HP归0，标记为死亡状态）<br>                                                                                                                                                                                                                                 |



---
力竭表格：

|力竭等级|对应效果（会与更低等级效果累积）|
|---|---|
|1|属性检定具有劣势。​|
|2|速度减半。​|
|3|攻击检定和豁免检定具有劣势。​|
|4|生命值上限减半。​|
|5|速度降为0。​|
|6|死亡。​|



---
问题：所有的状态可以拆分成多少个可以组合并编辑的功能？这些功能如何可以拼接成一个状态并与其绑定？每个功能到底应该如何实现？怎么做才能是最完美的、最有稳定性的、有可拓展性的以及优雅的？

---
# 以下内容全是规划（也就是上面问题的回答），你要将上下两部分对照着看，但是最终的需求落地还是依照下面的Bible
# 战斗状态系统重构与扩展 —— 实施路线图 & 规格Bible（无代码版）
版本：v1.0（可执行规格）  
适用范围：战斗界面（上方先攻序列 / 右下战场总览目标列表 / 左下动作选择与DM强制优势劣势 / 现有弹窗系统）  
约束：**禁止写代码**；本文作为实现时的唯一权威规格（Bible），任何实现细节不得偏离本文的“行为公理 / 决策表 / 触发时机”。

---

## 目录
1. [目标与非目标](#1-目标与非目标)
2. [名词表](#2-名词表)
3. [全局行为公理（优先级与抵消）](#3-全局行为公理优先级与抵消)
4. [数据模型变更（必须实现）](#4-数据模型变更必须实现)
5. [规则系统的模块划分（上帝视角）](#5-规则系统的模块划分上帝视角)
6. [评估管线（统一入口与触发时机）](#6-评估管线统一入口与触发时机)
7. [UI规格](#7-ui规格)
8. [条件（状态）定义与拼装表（配置级Bible）](#8-条件状态定义与拼装表配置级bible)
9. [DM弹窗规范（Prompt系统）](#9-dm弹窗规范prompt系统)
10. [实施路线图与里程碑（强依赖顺序）](#10-实施路线图与里程碑强依赖顺序)
11. [验收与测试矩阵（回归必测）](#11-验收与测试矩阵回归必测)
12. [兼容性/迁移策略与失败降级](#12-兼容性迁移策略与失败降级)
13. [扩展指南（未来新增状态/新规则时怎么做）](#13-扩展指南未来新增状态新规则时怎么做)

---

## 1. 目标与非目标

### 1.1 目标（必须达成）
A. 右下“战场总览”目标列表：  
- 当选中动作是**攻击检定动作**时，对每个目标在名字后方显示：  
  - 空 / 绿色“优势” / 红色“劣势” / 红色“无法选中”
- 当选中动作是**豁免检定动作**时，对每个目标在名字后方显示：  
  - 空 / 绿色“豁免自动失败”
- 并额外支持“状态型特殊标注徽标（Badge）”，如：  
  - 麻痹/昏迷：绿色“5尺内重击”  
  - 倒地：白色“5尺优势/远程劣势”  
  - 石化：红色“全抗性+免毒”

B. 上方先攻序列：  
- 每个生物显示其状态标签与持续回合（现有功能保留）  
- 新增：**点击状态标签**弹出“状态介绍窗口”，内容为该状态的 **核心效果(Key Effects)**（除力竭外文案原封不动）
- 新增：部分状态标签需要**红色边框**提示“该状态无法完全自动化”

C. 自动化逻辑（仅实现你表格要求的部分，不扩展到战斗外鉴定）：  
- 优势/劣势来源、抵消规则  
- 失能（不能动作/反应）  
- 豁免自动失败（STR/DEX 于麻痹/石化/震慑/昏迷）  
- 力竭3的攻击/豁免劣势，力竭4生命值上限减半与回退，力竭6死亡确认  
- 石化全抗性与免疫毒素/疾病（以伤害结算出口形式实现）

D. DM强制覆盖：  
- 左下角对攻击模式强制设为优势/劣势/无时：**覆盖系统自动计算**  
- 但仍不得突破“无法选中”（魅惑）限制

E. 魅惑（Charmed）必须支持“来源（source）”：  
- A 被 B 魅惑 ⇒ A 的攻击检定动作 **不能选择 B** 为目标  
- 点击 B 不选中，弹出提示：“不能将攻击检定的动作的攻击目标定为魅惑源头”

---

### 1.2 非目标（明确不做，避免实现跑偏）
- 不实现地图/距离系统；所有“5尺内/视线内”均由 DM 弹窗人工确认
- 不实现战斗外属性检定自动化（耳聋、力竭1/2等仅标签提示）
- 不追求把所有 D&D 规则自动化到完全正确；红框状态即表明需DM介入

---

## 2. 名词表
- **状态(Condition)**：如目盲/麻痹/倒地/力竭等
- **状态定义(ConditionDefinition)**：配置层（该状态的展示、说明文案、拼装的规则积木集合）
- **状态实例(ConditionInstance)**：某个生物身上的一条状态记录（含回合数、来源、等级等）
- **规则积木/原语(Effect Primitive)**：可组合的最小规则单元（如“目标禁选”“提供攻击优势来源”“豁免自动失败”等）
- **评估(Evaluate)**：在某一时刻基于 attacker/target/action/context 得到结论（可选性/优势劣势/自动失败/抗性等）
- **攻击检定动作(Attack Roll Action)**：会掷 d20 攻击检定的动作
- **豁免检定动作(Saving Throw Action)**：要求目标进行豁免的动作
- **DM强制攻击模式**：左下角对该动作强制设为 优势/劣势/无
- **Badge**：目标列表中状态附加的小徽标（独立于“优势/劣势/无法选中/自动失败”后缀）

---

## 3. 全局行为公理（优先级与抵消）

### 3.1 目标可选性的最高优先级
- 若当前动作是攻击检定动作，且目标命中“不可选规则”（魅惑）：
  1) 目标列表后缀必须显示：**红色“无法选中”**
  2) 点击该目标：**不改变选中目标**，弹提示框固定文案  
     > “不能将攻击检定的动作的攻击目标定为魅惑源头”
  3) 该限制优先于任何优势/劣势（包括 DM 强制优势）

### 3.2 攻击检定的优势/劣势抵消规则（不叠加、不比较数量）
- 只要存在任意优势来源 AND 任意劣势来源 ⇒ **直接抵消为普通**
- 不比较优势来源数量与劣势来源数量

### 3.3 DM强制覆盖优先级（但低于不可选）
- 若 DM 强制指定本次攻击模式为：
  - 优势 ⇒ 列表显示绿色“优势”，掷骰按优势
  - 劣势 ⇒ 列表显示红色“劣势”，掷骰按劣势
  - 无 ⇒ 列表不显示优势/劣势，掷骰普通
- 当 DM 强制存在时：系统自动优势/劣势仍可计算用于调试，但**不得影响最终结果**
- 当 DM 强制存在时：与“仅影响优势/劣势的DM弹窗”（倒地/恐慌）之间的交互见 [9.4](#94-弹窗与dm强制覆盖的关系必须固定)

### 3.4 豁免检定的显示规则（只显示“豁免自动失败”）
- 仅当：动作要求 STR 或 DEX 豁免 且 目标处于 麻痹/石化/震慑/昏迷  
  ⇒ 目标列表显示绿色“豁免自动失败”
- 其余情况不显示任何豁免后缀（即使目标豁免会劣势，如力竭3）

---

## 4. 数据模型变更（必须实现）

> 你现状：状态只有 type + 回合数。为了魅惑/恐慌/力竭，必须升级为可承载来源与等级。

### 4.1 ConditionInstance 必备字段
每条状态实例至少包含：
- `type`：状态类型（如 Blinded/Charmed/.../Exhaustion）
- `remainingRounds`：剩余回合（现有）
- **sourceId：用于魅惑(Charmed)必须；恐慌(Frightened)可选（当前的恐慌不依赖sourceId，而是人工判定）**
- `level`（可选但必须支持）：用于力竭 1~6

### 4.2 生物HP上限相关（力竭4必须）
每个生物必须能区分：
- `baseMaxHp`：原始最大生命值上限（不受力竭4影响的“基准”）
- `maxHp`：当前最大生命值上限（可能被力竭4改写）
- `hp`：当前生命值

规则要求：
- 获得力竭4时：`maxHp = floor(baseMaxHp * 0.5)`；若 `hp > maxHp` ⇒ `hp = maxHp`
- 力竭等级降至3或以下时：恢复 `maxHp = baseMaxHp`（hp不变）

> 若你现有模型没有 `baseMaxHp`：必须新增或通过初始值持久化，否则无法稳定回退。

### 4.3 力竭建议建模（强建议，作为Bible要求）
- 使用单一 `type = Exhaustion`，并用 `level=1..6` 表示等级  
- UI标签显示 “力竭X级”
- 不要用“力竭1级/力竭2级 ...”做6种type，否则升降级与回退逻辑易碎

---

## 5. 规则系统的模块划分（上帝视角）

### 5.1 ConditionDefinition Registry（配置注册表）
每种状态定义必须配置：
- 显示名（中文/英文可选）
- Key Effects 文案（除力竭外必须原封不动）
- 是否红框 `requiresDMHighlight`
- 绑定的规则积木列表（见 5.2）
- 绑定的目标列表 Badge 列表（如需）
- （若为力竭）绑定表格展示数据

### 5.2 Effect Primitives（规则积木最小集合）
必须具备以下积木类型（概念实现，不写代码）：

1. **TargetSelectionBlocker**
   - 输出：`blocked=true/false` + `reasonText`
   - 用于：魅惑（攻击检定动作禁选魅惑源头）

2. **AttackAdvantageContributor / AttackDisadvantageContributor**
   - 输出：对本次“攻击者→目标”的攻击检定是否提供优势/劣势来源（布尔）
   - 用于：目盲、隐形、束缚、麻痹、石化、震慑、昏迷、中毒、倒地（部分需弹窗）

3. **SaveAutoFailRule**
   - 输出：`autoFail=true/false`
   - 用于：麻痹/石化/震慑/昏迷对 STR/DEX 豁免自动失败

4. **SaveDisadvantageRule**
   - 输出：豁免掷骰是否劣势
   - 用于：力竭3+（目标掷豁免劣势）

5. **CapabilityLockRule**
   - 输出：`cannotAct` `cannotReact`
   - 用于：失能、麻痹、石化、震慑、昏迷

6. **DamageResistanceRule**
   - 输出：伤害修正（至少支持：全抗性）
   - 用于：石化全抗性

7. **ImmunityRule（信息/结算出口）**
   - 输出：免疫集合（至少：毒素/疾病）
   - 用于：石化免疫毒素和疾病（即使当前系统未全面使用，也必须作为统一出口）

8. **PromptedRule（DM决策型积木）**
   - 输出：通过弹窗得到的“决策结果”，影响优势/劣势或重击
   - 用于：
     - 恐慌：恐惧源是否在视线内？（判定命中前）
     - 倒地：是否5尺内？（判定命中前）
     - 麻痹/昏迷：命中后是否5尺内？（命中后伤害前）

9. **TargetListBadgeRule（纯UI徽标）**
   - 输出：Badge 列表（文字+颜色）
   - 用于：麻痹/昏迷、倒地、石化等固定标注

---

## 6. 评估管线（统一入口与触发时机）

> 任何自动化必须通过这些入口发生，避免“某UI组件里写if/else导致规则分裂”。

### 6.1 入口一：目标列表评估（右下战场总览渲染时）
输入（概念）：
- 当前行动者 attacker
- 当前选中动作 action（攻击检定/豁免检定）
- 候选目标 target（列表逐个评估）
- DM强制攻击模式（仅攻击检定动作）

输出：
- `selectable`（能否选中）
- `suffixType`（严格枚举：None / Advantage / Disadvantage / Blocked / SaveAutoFail）
- `badges[]`（可为空）

必须规则：
- 攻击检定动作：
  1) 先评估 TargetSelectionBlocker（魅惑）
  2) blocked ⇒ suffix=Blocked（无法选中），selectable=false
  3) 否则若 DM强制存在 ⇒ suffix由DM强制决定（Adv/Disadv/None）
  4) 否则汇总系统优势/劣势贡献并抵消后得 suffix
- 豁免检定动作：
  - 只评估 SaveAutoFailRule（STR/DEX自动失败），决定 suffix=SaveAutoFail 或 None
  - selectable永远为true（魅惑不影响豁免动作）

> 注意：倒地/恐慌的“需要弹窗才能决定优势劣势”不应在目标列表阶段弹窗（避免“还没攻击就弹窗”）。因此它们在目标列表阶段只通过 Badge 提醒（见 [8.11 倒地](#811-倒地-prone)）。

### 6.2 入口二：点击目标（右下列表点击）
- 若 selectable=false：
  - 不改变当前选中目标
  - 弹提示 reasonText（魅惑固定文案）
- 若 selectable=true：
  - 正常选中目标

### 6.3 入口三：判定命中前（开始掷攻击/计算命中那一刻）
输入：
- attacker、target、action、DM强制、已缓存的 decisions（见 6.5）

流程（概念顺序固定）：
1) 若目标不可选（魅惑）仍需在此阶段再次硬校验（防止绕过UI）  
   - 不可选 ⇒ 直接中止本次攻击流程并提示
1) 若 DM强制存在（强制规定本次攻击检定的攻击是优势、劣势或者无）：
   - 最终攻击模式=DM强制
   - **所有的在右下方战场总览中的优势劣势标注（包括倒地和恐慌）全都取消触发**（因为提示的作用已经没有了，这个见 [9.4](#94-弹窗与dm强制覆盖的关系必须固定)）%%注意： 当前情况是唯一一种倒地和恐慌不会在计算攻击是否命中前弹出是否5尺内判断窗口的情况 %%

1) 否则：
   - 汇总系统优势/劣势来源
   - 若需要 Prompt 决策（倒地/恐慌）且尚无缓存 ⇒ 弹窗询问并写入缓存
   - 抵消后得到最终攻击模式：优势/劣势/普通

### 6.4 入口四：命中后、伤害前（点击“造成伤害/结算伤害”那一瞬间）
- 若目标具有 麻痹/昏迷（或你定义为同等规则的状态）：
  - 若尚未对“是否5尺内”做出缓存决策 ⇒ 弹窗询问
  - 若回答“是” ⇒ 本次伤害按重击（critical hit）处理
- 注意：此弹窗**不得**出现在“选择目标”或“掷攻击前”。

### 6.5 入口五：豁免结算时（掷豁免骰/判定结果那一刻）
- 若 SaveAutoFailRule 为 true ⇒ 不掷骰，直接失败（并与UI后缀一致）
- 否则若 SaveDisadvantageRule 为 true ⇒ 以劣势掷豁免
- 其余 ⇒ 正常掷豁免

### 6.6 决策缓存（强制要求，避免重复弹窗）
每次“攻击流程实例”必须有一个可唯一定位的键，例如：
- attackerId + targetId + actionId + timestamp/sequence
缓存内容包含：
- proneWithin5ft?（倒地）
- fearSourceInSight?（恐慌）
- critWithin5ft?（麻痹/昏迷命中后）

要求：
- 同一次攻击在命中前/命中后阶段不要重复询问同一问题
- 换目标/换动作/重新发起一次攻击则重新询问

---

## 7. UI规格

### 7.1 右下“战场总览”目标列表行结构（强制）
每个目标行渲染为三段（视觉上可紧凑，但逻辑分离）：
1) **目标名称**（原样）
2) **动态后缀Suffix**（严格枚举之一）  
   - 攻击检定动作：空 / 优势 / 劣势 / 无法选中  
   - 豁免检定动作：空 / 豁免自动失败
3) **Badges徽标区**（可多个）
   - 例：`[5尺内重击]`、`[全抗性+免毒]`、`[5尺优势/远程劣势]`

#### 7.1.1 颜色与样式（必须统一）
- “优势”：绿色（主题成功色），文本“优势”
- “劣势”：红色（主题危险色），文本“劣势”
- “无法选中”：红色（主题危险色），文本“无法选中”
- “豁免自动失败”：绿色（主题成功色），文本“豁免自动失败”
- Badge颜色：
  - 麻痹/昏迷“5尺内重击”：绿色
  - 倒地“5尺优势/远程劣势”：白色/中性色（不偏利弊）
  - 石化“全抗性+免毒”：红色

> 备注：Badge与Suffix必须并存且互不替代。Suffix只表达“本次动作下的最终可见结论”；Badge表达“固定提醒信息”。

### 7.2 上方先攻序列：状态标签样式与交互
- 每个生物卡片展示该生物的状态标签（现有）+ 回合数（现有）
- **红框提示**：对 `requiresDMHighlight=true` 的状态标签，边框改为主题红色
- **点击标签**：打开“状态介绍弹窗”（见 7.3）

### 7.3 状态介绍弹窗：内容组织规范（必须遵守）
弹窗结构（推荐但强制包含关键字段）：
- Header：
  - 标题：`状态中文名`（可附英文名）
  - 右上角关闭
- Body：
  - 区块标题：`核心效果 (Key Effects)`
  - 内容：**严格使用你表格中的Key Effects文案**
    - 除力竭外：文案必须原封不动（可做换行、列表化，但不得改字）
    - 力竭：不使用原Key Effects段落，而是展示“力竭表格”（见 7.3.2）
- Footer（可选）：
  - 若该状态为红框提示：显示一行轻提示  
    “提示：该状态部分效果无法自动化，请DM自行裁定。”

#### 7.3.1 Key Effects排版规则
- 允许把 `<br>` 换成项目符号列表（每一条就是原文一条）
- 不允许：
  - 改写句子
  - 合并/拆分导致语义变化
  - 添加额外规则内容到 Key Effects 区块内

#### 7.3.2 力竭弹窗内容（必须使用表格）
力竭弹窗 Body：
- 标题：`力竭 (Exhaustion)`
- 子标题：若生物当前有力竭等级，显示：`当前等级：X级`
- 表格：必须展示以下表格（原样）

|力竭等级|对应效果（会与更低等级效果累积）|
|---|---|
|1|属性检定具有劣势。​|
|2|速度减半。​|
|3|攻击检定和豁免检定具有劣势。​|
|4|生命值上限减半。​|
|5|速度降为0。​|
|6|死亡。​|

---

## 8. 条件（状态）定义与拼装表（配置级Bible）

> 本节是“状态 = 规则积木 + UI标记 + 触发时机”的唯一真相来源。  
> 除表格声明内容外，不得引入额外自动化。

### 8.1 目盲 (Blinded) — 红框
**Key Effects（原封不动）：**  
- 无法视物；  
- 依赖视觉的属性检定自动失败；  
- 针对你的攻击检定具有优势；  
- 你的攻击检定具有劣势；

**自动化：**
- 作为目标：攻击者获得攻击优势来源
- 作为攻击者：其攻击获得劣势来源
- 目标列表Suffix：由汇总器决定（可被DM强制覆盖）
- 标签：红框

---

### 8.2 魅惑 (Charmed) — 红框，必须来源sourceId
**Key Effects（原封不动）：**  
- 无法攻击魅惑者或以有害能力/魔法效应指定魅惑者；  
- 魅惑者对你进行的任何社交互动检定具有优势；

**数据要求：**
- 该状态实例必须支持 `sourceId`（魅惑源头）
- 允许同一生物同时存在多个 Charmed 实例（不同sourceId）

**自动化（仅攻击检定动作生效）：**
- 若 attacker 身上存在 Charmed(sourceId = target.id) ⇒ target **不可选**
- 目标列表Suffix：红色“无法选中”
- 点击不可选目标：弹提示固定文案  
  “不能将攻击检定的动作的攻击目标定为魅惑源头”
- 标签：红框

---

### 8.3 耳聋 (Deafened) — 红框（仅标签）
**Key Effects（原封不动）：**  
- 无法听见；  
- 依赖听觉的属性检定自动失败；

**自动化：**
- 无（仅作为标签提示）
- 标签：红框

---

### 8.4 恐慌 (Frightened) — 红框（每次攻击检定都需DM裁定）
**Key Effects（原封不动）：**  
- 当恐惧源在视线内时，属性检定和攻击检定具有劣势；  
- 不能主动靠近恐惧源 。

**数据说明：sourceId 可选；当前版本的恐慌自动化不依赖 sourceId**

**自动化（攻击检定动作，作为攻击者时）：**
- 判定命中前弹窗询问：恐惧源是否在视线内？
  - 是 ⇒ 本次攻击劣势来源
  - 否 ⇒ 无影响
- 标签：红框

---

### 8.5 擒抱 (Grappled) — 红框（仅标签）
**Key Effects（原封不动）：**  
- 速度降为0，且无法从任何速度加值中获益 。

**自动化：**
- 无（仅标签提示）
- 标签：红框

---

### 8.6 失能 (Incapacitated)
**Key Effects（原封不动）：**  
- 无法执行动作或反应 。

**自动化：**
- 不能动作、不能反应（复用你现有“灰化/不可行动”机制）
- 标签：正常（不红框）

---

### 8.7 隐形 (Invisible) — 红框
**Key Effects（原封不动）：**  
- 在没有魔法或特殊感官辅助的情况下无法被看见；  
- 被视为处于重度遮蔽区域；  
- 针对你的攻击检定具有劣势；  
- 你的攻击检定具有优势 。

**自动化：**
- 攻击隐形目标 ⇒ 攻击者劣势来源
- 隐形者发起攻击 ⇒ 攻击者优势来源
- 标签：红框

---

### 8.8 麻痹 (Paralyzed)
**Key Effects（原封不动）：**  
- 处于失能状态，无法移动或说话；  
- 力量和敏捷豁免自动失败；  
- 针对你的攻击检定具有优势；  
- 5尺内的攻击者若命中则为重击 。

**自动化：**
- 失能（不能动作/反应）
- 作为目标：攻击者优势来源
- 豁免：STR/DEX ⇒ 自动失败
- 命中后伤害前：弹窗询问“是否5尺内？”  
  - 是 ⇒ 本次伤害按重击
- 目标列表Badge：绿色“5尺内重击”

---

### 8.9 石化 (Petrified)
**Key Effects（原封不动）：**  
- 变为固态无机物；  
- 处于失能状态，无法移动、说话且对周围环境无感知；  
- 力量和敏捷豁免自动失败；  
- 针对你的攻击检定具有优势；  
- 获得对所有伤害的抗性；  
- 免疫毒素和疾病 。

**自动化：**
- 失能（不能动作/反应）
- 作为目标：攻击者优势来源
- 豁免：STR/DEX ⇒ 自动失败
- 伤害：全抗性（所有伤害类型半伤）
- 免疫：毒素、疾病（至少作为统一出口数据）
- 目标列表Badge：红色“全抗性+免毒”

---

### 8.10 中毒 (Poisoned)
**Key Effects（原封不动）：**  
- 攻击检定和属性检定具有劣势。

**自动化：**
- 作为攻击者：攻击劣势来源

---

### 8.11 倒地 (Prone)
**Key Effects（原封不动）：**  
- 唯一的移动选项是爬行；  
- 攻击检定具有劣势；  
- 5尺内的攻击者对你的攻击检定具有优势，超过5尺的攻击者则具有劣势 。

**自动化：**
- 倒地者作为攻击者：攻击劣势来源（固定）
- 攻击倒地目标：在**判定命中前**弹窗询问“是否5尺内？”
  - 是 ⇒ 攻击优势来源
  - 否 ⇒ 攻击劣势来源
- 目标列表Badge：白色“5尺优势/远程劣势”
- 重要：目标列表Suffix不应因倒地自动显示优势/劣势（因为需要弹窗决策）

---

### 8.12 束缚 (Restrained) — 红框
**Key Effects（原封不动）：**  
- 速度降为0；  
- 针对你的攻击检定具有优势，你的攻击检定具有劣势；  
- 敏捷豁免具有劣势 。

**自动化：**
- 作为目标：攻击者优势来源
- 作为攻击者：攻击者劣势来源
- （敏捷豁免劣势：你表格未要求实现到目标豁免掷骰阶段；如要实现需新增SaveDisadvantage限定为DEX。当前按“省去的部分不用管”，不做。）
- 标签：红框

---

### 8.13 震慑 (Stunned)
**Key Effects（原封不动）：**  
- 处于失能状态，无法移动，只能结巴地说话；  
- 力量和敏捷豁免自动失败；  
- 针对你的攻击检定具有优势 。

**自动化：**
- 失能（不能动作/反应）
- 作为目标：攻击者优势来源
- 豁免：STR/DEX ⇒ 自动失败

---

### 8.14 昏迷 (Unconscious)
**Key Effects（原封不动）：**  
- 处于失能状态，无法移动、说话且对周围环境无感知；  
- 丢下手中物品并倒地；  
- 力量和敏捷豁免自动失败；  
- 针对你的攻击检定具有优势；  
- 5尺内的攻击者若命中则为重击

**自动化：**
- **与麻痹一模一样**（按你要求）：
  - 失能（不能动作/反应）
  - 作为目标：攻击者优势来源
  - 豁免：STR/DEX ⇒ 自动失败
  - 命中后伤害前：询问“是否5尺内？” 是则重击
  - 目标列表Badge：绿色“5尺内重击”

---

### 8.15 力竭 (Exhaustion) — 红框，level 1~6
**弹窗说明：使用力竭表格（见 7.3.2）**

**自动化（按等级）：**
- level 1：仅标签提示
- level 2：仅标签提示
- level 3：
  - 作为攻击者：攻击劣势来源
  - 作为豁免目标：豁免掷骰劣势（SaveDisadvantageRule）
- level 4：
  - 同 level 3
  - 触发：生命值上限减半（floor），并必要时压低当前HP
  - 回退：降到 level<=3 时恢复原上限（HP不变）
- level 5：
  - 同 level 4（速度降为0仅标签提示，不做地图）
- level 6：
  - 触发：弹确认框  
    “[生物名]因力竭6级而死亡，是否确认？”
  - 确认后：立即死亡（HP归0 + 标记死亡状态/逻辑）

---

## 9. DM弹窗规范（Prompt系统）

### 9.1 弹窗类型（必须复用现有弹窗系统）
本文定义三类弹窗交互：
1) **信息提示（Toast/Alert）**：魅惑点击不可选目标
2) **二选一询问（Yes/No Prompt）**：倒地5尺/恐慌视线/麻痹重击5尺
3) **确认（Confirm）**：力竭6死亡确认

### 9.2 Prompt文案（固定）
- 倒地（判定命中前）：  
  标题：`倒地判定`  
  内容：`攻击者是否在目标5尺内？`  
  按钮：`是（5尺内）` / `否（超过5尺）`

- 麻痹/昏迷（命中后伤害前）：  
  标题：`重击判定`  
  内容：`攻击者是否在目标5尺内？命中则为重击。`  
  按钮：`是（重击）` / `否（普通伤害）`

- 恐慌（判定命中前）：  
  标题：`恐慌判定`  
  内容：`恐惧源是否在视线内？`  
  按钮：`是（攻击劣势）` / `否（正常）`

- 力竭6死亡确认：  
  标题：`确认死亡`  
  内容：`[生物名]因力竭6级而死亡，是否确认？`  
  按钮：`确认` / `取消`

### 9.3 Prompt触发时机（再次强调）
- 倒地：判定命中前（不在选目标时）
- 恐慌：判定命中前
- 麻痹/昏迷重击：命中后、伤害前（不在选目标时）
- 力竭6：状态等级变更到6的瞬间（立即触发确认）

### 9.4 弹窗与DM强制覆盖的关系（必须固定）
为避免无意义弹窗，并严格体现“DM强制优先级”，规定如下：

- **当 DM 强制攻击模式存在时：**
  - 倒地/恐慌这类“仅影响本次攻击优势/劣势”的 Prompt **默认不触发**
  - 麻痹/昏迷“命中后重击” Prompt **仍必须触发**（因为它影响伤害阶段，不是优势劣势）
- 理由：DM强制覆盖是对“掷攻击方式”的最终裁决，但不应跳过“命中后重击”的特殊规则。

> 若你强烈希望“即便DM强制也弹倒地/恐慌”，必须在实现前明确改写Bible；否则按本条执行。

---

## 10. 实施路线图与里程碑（强依赖顺序）

> 你要“可执行顺序与里程碑”。以下按**最小可交付**与**风险前置**排序：先打通数据与UI，再做魅惑与评估管线，然后接入各类Prompt与力竭钩子。

每个里程碑都包含：交付物、实现要点、验收标准、回归风险点。

---

### M0：现状审计与开工基线（1次性任务）
**交付物：**
- 列出当前战斗流程关键节点（至少能定位）：
  1) 选动作
  2) 目标列表渲染
  3) 点击目标
  4) 掷攻击/判定命中
  5) 命中后结算伤害按钮
  6) 豁免动作的结算节点
- 列出当前“状态显示/回合数管理/生物灰化失能”代码位置（文件/模块名）

**验收标准：**
- 开发者能明确“应该把新评估入口挂在哪些时刻”，避免写到错误阶段导致弹窗时机错乱。

---

### M1：数据模型升级（sourceId / level / baseMaxHp）
**实现要点：**
- ConditionInstance 增加 `sourceId?`、`level?`
- 生物增加 `baseMaxHp`（或等效可回退字段）

**验收标准：**
- 原有战斗加载不崩溃：旧状态缺字段时一律安全默认（见 [12](#12-兼容性迁移策略与失败降级)）
- 任意生物可持有：
  - 多个 Charmed（不同sourceId）
  - 一个 Exhaustion（level可变）
- baseMaxHp 在整个战斗过程中可稳定回退（不会因多次修改丢失原值）

**回归风险点：**
- 旧存档兼容
- HP上限被别处逻辑改写导致baseMaxHp不可信（必须明确“谁能改baseMaxHp”）

---

### M2：状态标签红框 & 状态介绍弹窗（先攻序列侧）
**实现要点：**
- 引入 ConditionDefinition Registry（至少包含：显示名、Key Effects、requiresDMHighlight、是否Exhaustion表格）
- 先攻序列状态标签：
  - 按 requiresDMHighlight 渲染红色边框
  - 点击打开状态介绍弹窗（按 [7.3](#73-状态介绍弹窗内容组织规范必须遵守) 组织内容）
- 力竭弹窗显示表格（固定）

**验收标准：**
- 每个状态标签可点击打开对应说明
- 红框状态全部正确（Blinded/Charmed/Deafened/Frightened/Grappled/Invisible/Restrained/Exhaustion）
- Key Effects 文案不被改写（除排版换行）
- 力竭显示为表格，不显示普通Key Effects段

**回归风险点：**
- 状态标签点击事件与现有“移除状态/编辑回合”功能冲突（如存在需协调交互：建议区分点击区域或右键菜单）

---

### M3：目标列表“Suffix + Badge”渲染框架（不含魅惑）
**实现要点：**
- 目标列表行结构改造为：Name + Suffix + Badges
- 新增“目标列表评估入口”（见 [6.1](#61-入口一目标列表评估右下战场总览渲染时)）但先只做：
  - Suffix：根据 DM强制 或 系统优势劣势抵消（先实现不需弹窗的来源）
  - Badges：先接入固定Badge（麻痹/昏迷/倒地/石化）
- 仍不做点击不可选，因为魅惑未接入

**验收标准：**
- 当选中攻击检定动作时：
  - 目盲/隐形/束缚/中毒/力竭3 等能让Suffix正确显示优势/劣势/空（并能抵消）
  - DM强制优势/劣势/无时，Suffix完全按DM显示
- 当选中豁免检定动作时：
  - 能显示“豁免自动失败”（先可只覆盖麻痹/昏迷/震慑/石化中的任意一个用于验证）
- Badge显示：
  - 麻痹/昏迷：绿色“5尺内重击”
  - 倒地：白色“5尺优势/远程劣势”
  - 石化：红色“全抗性+免毒”

**回归风险点：**
- 目标列表刷新频率（动作切换/选择攻击者切换/状态变化）必须实时更新Suffix与Badge

---

### M4：魅惑（Charmed）来源选择UI + 不可选目标逻辑（核心高风险）
**实现要点：**
1) 施加 Charmed 状态时：必须让DM选择 source（来源生物）
   - UI：在“添加状态”流程中对 Charmed 额外弹出“选择魅惑源头”的选择框
   - 必须允许多来源（多条实例）
2) 目标列表评估中接入 TargetSelectionBlocker：
   - 仅当当前动作是攻击检定动作生效
3) 点击不可选目标：
   - 不选中
   - 弹提示固定文案

**验收标准：**
- A 被 B 魅惑：A 选攻击动作 ⇒ B 显示“无法选中”，点击提示且不选中
- A 选豁免动作 ⇒ B 可选中（魅惑不影响豁免）
- 多来源魅惑：B/C都不可选
- 若 Charmed 缺少 sourceId（见降级策略）：系统不做禁选，但红框仍提示DM（见 [12](#12-兼容性迁移策略与失败降级)）

**回归风险点：**
- 禁选必须在“点击目标”与“开始攻击流程”两个层面都硬校验（防绕过）
- source生物被移出战斗/死亡：只要仍在列表中就禁选；不在列表中则自然不可选（无需额外逻辑）

---

### M5：倒地/恐慌（判定命中前Prompt）接入攻击流程
**实现要点：**
- 改造“判定命中前入口”（见 [6.3](#63-入口三判定命中前开始掷攻击计算命中那一刻)）
- 倒地：
  - 仅在攻击倒地目标且DM未强制时触发5尺弹窗
- 恐慌：
  - 攻击者具恐慌且DM未强制时触发“视线内？”弹窗
- 引入决策缓存（见 [6.6](#66-决策缓存强制要求避免重复弹窗)）

**验收标准：**
- 倒地弹窗不在选目标阶段出现，只在掷攻击前出现
- 恐慌弹窗同理
- 同一次攻击不会重复询问同一问题
- DM强制存在时不弹倒地/恐慌弹窗（按Bible [9.4](#94-弹窗与dm强制覆盖的关系必须固定)）

**回归风险点：**
- Prompt触发顺序：若倒地与恐慌同时存在，必须按统一顺序询问（建议先倒地后恐慌，或反之；必须固定并记录）
- Prompt回答必须只影响本次攻击实例，不污染后续攻击

---

### M6：麻痹/昏迷（命中后伤害前Prompt：重击）接入伤害流程
**实现要点：**
- 在“命中后、伤害前入口”触发重击判定弹窗
- 引入并使用决策缓存（避免重复）
- 注意：此逻辑不受DM强制优势劣势影响（必须仍触发）

**验收标准：**
- 对麻痹/昏迷目标命中后，点击造成伤害时才弹窗
- 选择“5尺内”则按重击结算伤害
- 选择“超过5尺”则正常伤害
- 不命中时绝不弹窗

**回归风险点：**
- “命中状态”的判定必须来自你现有命中逻辑，不能被UI误触发

---

### M7：豁免自动失败显示与结算（STR/DEX）+ 力竭豁免劣势
**实现要点：**
- 目标列表（豁免动作）：根据 SaveAutoFailRule 显示“豁免自动失败”
- 豁免结算入口：
  - autoFail ⇒ 直接失败
  - 否则若力竭>=3 ⇒ 以劣势掷豁免
- 覆盖状态：麻痹/昏迷/震慑/石化（STR/DEX自动失败），力竭3（豁免劣势）

**验收标准：**
- STR/DEX豁免对上述目标：列表显示“豁免自动失败”，结算不掷骰直接失败
- 非STR/DEX：不显示自动失败
- 力竭3+：非自动失败情况下，豁免以劣势掷骰

---

### M8：石化全抗性 + 免疫出口（伤害阶段）
**实现要点：**
- 在伤害结算的统一入口输出“伤害修正”结构，至少支持：
  - 全抗性（所有伤害类型减半）
- 免疫毒素/疾病作为结构输出（即使暂时不用于计算，也要可被其他模块读取）

**验收标准：**
- 对石化目标造成任意伤害，最终伤害减半（向下取整/四舍五入规则由你系统现有规范决定，但必须固定并写入项目内的全局伤害舍入规范）
- 目标列表Badge显示“全抗性+免毒”
- 免疫字段能在调试/日志中观测到（或在UI将来可用）

---

### M9：力竭等级系统（3/4/6关键钩子）
**实现要点：**
- 力竭为单一状态 + level
- level 3：
  - 攻击劣势来源
  - 豁免劣势（见M7已接入）
- level 4：
  - 上限减半与回退（见 [4.2](#42-生物hp上限相关力竭4必须)）
- level 6：
  - 弹确认框；确认后死亡（HP=0 + 死亡标记）

**验收标准：**
- 升到4：上限正确减半，HP必要时下压
- 从4降到3：上限恢复，HP不变
- 到6：弹窗确认；取消则不死亡（力竭等级是否仍为6需你决定：建议取消则不应用到6，保持5；但必须固定并实现一致）
- 红框标签正确；弹窗显示力竭表格

> **Bible强制决策：力竭6确认“取消”的行为**
> - 建议固定为：取消 ⇒ 不把等级设为6（仍保持为5），避免出现“已是6但未死亡”的矛盾状态。
> - 若你不同意，必须在实现前改写本条并全局一致。

---

### M10：全量回归、边界测试、性能与一致性收尾
**实现要点：**
- 以 [11](#11-验收与测试矩阵回归必测) 为最小回归集
- 统一所有状态说明弹窗内容与红框名单
- 检查所有Prompt触发时机与缓存正确性

**验收标准：**
- 回归用例100%通过
- 不出现“选目标就弹窗”“不可选还能通过快捷方式选中”等绕过漏洞
- 目标列表显示与实际结算一致（尤其：DM强制覆盖）

---

## 11. 验收与测试矩阵（回归必测）

### 11.1 优势/劣势抵消与DM覆盖
1) 攻击者中毒（劣势）+ 目标目盲（优势） ⇒ 抵消 ⇒ Suffix空  
2) 上述情况下 DM强制优势 ⇒ Suffix显示“优势”，实际掷骰优势  
3) DM强制无 ⇒ Suffix空，实际普通  
4) 同时多优势来源仍只显示“优势”（不叠加）

### 11.2 魅惑禁选（攻击 vs 豁免）
1) A 被 B 魅惑：攻击动作下 B 显示“无法选中”，点击提示且不选中  
2) A 换成豁免动作：B 可选  
3) A 被 B、C 魅惑：B/C都不可选  
4) 试图绕过UI（例如通过其他方式设置targetId）：开始攻击前仍被硬阻止并提示

### 11.3 倒地/恐慌弹窗时机
1) 倒地目标：不在目标列表/选目标时弹窗，只在掷攻击前弹  
2) 恐慌攻击者：同理  
3) DM强制存在：倒地/恐慌不弹窗（按Bible）  
4) 同一次攻击不重复问

### 11.4 麻痹/昏迷重击弹窗时机
1) 未命中不弹  
2) 命中后在“造成伤害”那一刻弹  
3) 选择5尺内 ⇒ 重击伤害  
4) DM强制存在也必须弹（因为影响伤害非优势劣势）

### 11.5 豁免自动失败
1) STR豁免对麻痹目标：列表显示“豁免自动失败”，结算直接失败  
2) WIS豁免对麻痹目标：列表不显示自动失败，正常结算  
3) STR豁免对非麻痹/石化/震慑/昏迷：不显示自动失败

### 11.6 石化伤害修正
- 对石化目标造成任何伤害 ⇒ 最终伤害减半（并保证舍入规则一致）

### 11.7 力竭4/6
- 升4减半、降回3恢复、升6确认死亡（取消行为按Bible固定）

---

## 12. 兼容性/迁移策略与失败降级

### 12.1 旧战斗数据（缺 sourceId / level）必须不崩溃
- Charmed/Frightened 缺 sourceId：
  - 不执行自动禁选/视线Prompt（避免误伤）
  - 标签仍红框，DM可见“该状态需手动裁定”
- Exhaustion 缺 level：
  - 默认视为 level=1（仅标签）或提示DM补全（两者选其一并固定）
  - 推荐：默认 level=1，防止出现未知等级导致崩溃

### 12.2 source生物不存在/不在场
- 允许 sourceId 为空（代表“源头不在战斗中或未知”）
- 该情况下：
  - 魅惑：不自动禁选（因为无从识别目标）
  - 恐慌：无论是否配置 sourceId，都在“判定命中前”弹窗询问：`恐惧源是否在视线内？`

### 12.3 舍入规则（全局必须固定）
- 石化全抗性、以及任何“减半”伤害：向下取整/四舍五入必须统一  
- 若你项目已有规范：沿用并记录在项目README；若没有：Bible要求 **向下取整**（推荐与D&D一致）

---

## 13. 扩展指南（未来新增状态/新规则时怎么做）

当新增一个状态时，必须按以下流程：
1) 在 ConditionDefinition Registry 中新增该状态：
   - 显示名、Key Effects、红框标记
2) 选择并组合已有 Effect Primitives：
   - 不允许在UI组件里直接写业务if/else（防规则分裂）
3) 若出现新类型规则（例如“持续伤害”“速度影响与地图联动”等）：
   - 新增一个 Primitive，并接入对应评估入口（目标列表/判定命中前/伤害前/豁免结算/伤害结算/能力限制）
4) 新增状态必须补充至少3条回归用例，并加入 [11](#11-验收与测试矩阵回归必测)

---

# 附：红框状态清单（必须完全一致）
- 目盲 (Blinded)
- 魅惑 (Charmed)
- 耳聋 (Deafened)
- 恐慌 (Frightened)
- 擒抱 (Grappled)
- 隐形 (Invisible)
- 束缚 (Restrained)
- 力竭 (Exhaustion 1~6)

---

# 附：目标列表Suffix允许值（禁止扩展为更多文案）
- 攻击检定动作：`""` / `"优势"` / `"劣势"` / `"无法选中"`
- 豁免检定动作：`""` / `"豁免自动失败"`

（除上述外，任何额外提示一律用Badge承载）


