# 状态/HP/持久化复现矩阵（回归必测）

目标：用最少的手工步骤覆盖最容易“悄悄错”的状态链路（优势劣势、豁免自动失败、力竭、回合递减、tempHp、恢复存档）。

## A. 自动扣血与 tempHp

- A1：attack 自动扣血应先消耗 tempHp
  - 准备：任意目标设置 `tempHp=5`、`hpCurrent=10`，执行攻击造成 7 点伤害，开启“自动扣血”
  - 期望：`tempHp` 变为 0，`hpCurrent` 变为 8
- A2：save 自动扣血与 attack 行为一致
  - 准备：同 A1，但改用豁免动作，最终伤害 7
  - 期望：与 A1 一致

## B. 怪物归零提示与回合结束移除

- B1：怪物 hp 归零时应提示“回合结束后移除”，并在 nextTurn 后移除
  - 准备：怪物 `hpCurrent` 扣到 0
  - 期望：出现提示；推进回合后该怪物从 participants 移除
- B2：PC hp 归零不应被自动移除
  - 准备：PC `hpCurrent` 扣到 0
  - 期望：推进回合后仍存在

## C. 回合递减时机（off-by-one 验证）

- C1：rounds=1 的状态应在“谁的回合结束”被移除
  - 准备：给行动者 A 加一个 `rounds=1` 的状态；推进回合一次
  - 期望：该状态在符合语义的时机消失（以 UI 设计为准：通常是 A 结束回合时消失）
- C2：动作冷却 cooldown 递减与 C1 同一时机
  - 准备：给行动者 A 的某动作设 `cooldown=1`；推进回合一次
  - 期望：冷却变 0 的归属与 C1 一致

## D. 状态自然过期的副作用（力竭 HP 上限回退）

- D1：力竭 4+ 生效时应将 hpMax 设为 floor(baseMaxHp/2)
  - 准备：`baseMaxHp=21`，添加力竭（meta.level=4），确保 `rounds>=1`
  - 期望：`hpMax=10`，若 `hpCurrent>10` 则被压到 10
- D2：力竭状态因 rounds 递减到 0 被自动移除后，应恢复 hpMax
  - 准备：力竭 `rounds=1`；推进回合一次使其过期
  - 期望：`hpMax` 恢复为 `baseMaxHp`

## E. 力竭 6 死亡确认回退

- E1：力竭 6 确认后应立即死亡（hp=0）并标记
  - 准备：添加/设置力竭到 level 6 并点击确认
  - 期望：`hpCurrent=0` 且有死亡标记（怪物应在回合结束移除）
- E2：力竭 6 取消后应回退到 5（且 hpMax 仍保持减半）
  - 准备：同 E1 但点击取消
  - 期望：level 变为 5；若 level>=4 仍减半

## F. 持久化恢复（刷新/重开页面）

- F1：状态（含 sourceUid/meta/rounds）刷新后不丢失，且仍可继续递减
  - 准备：给单位添加多条状态（含需要来源的那类）并刷新页面
  - 期望：状态仍存在且 round/递减逻辑正常
- F2：justJoined 中间态刷新不会导致永久跳过
  - 准备：先攻已开始时加入新单位，使其 `justJoined=true`；刷新
  - 期望：新单位不会被永远跳过，回合绕回后可正常行动

## G. 导入数据兼容性

- G1：导入后不进编辑器直接执行动作，不应因字段缺失报错
  - 准备：导入一份较旧导出（或删字段模拟），直接进入战斗执行攻击/豁免
  - 期望：可用且兼容分支生效（必要字段被补齐或安全降级）

