<div align="center">
  <img src="./icon-512.png" alt="项目Logo" width="100" />
  <h1>D&D战斗助手 (D&D Combat Assistant)</h1>
  <p>一款为DM打造的本地化D&D战斗辅助工具</p>
  
  <p>
    <img alt="Vue.js" src="https://img.shields.io/badge/Vue.js-3-4FC08D?style=for-the-badge&logo=vue.js">
    <img alt="Local-First" src="https://img.shields.io/badge/Data-Local First-F7DF1E?style=for-the-badge&logo=javascript">
    <img alt="PWA Ready" src="https://img.shields.io/badge/PWA-Ready-5A0FC8?style=for-the-badge&logo=pwa">
    <img alt="License" src="https://img.shields.io/badge/License-MIT-blue.svg?style=for-the-badge">
  </p>
</div>

---

## 简介

**D&D战斗助手**是一个纯本地化的战斗辅助工具，无需注册、无需联网、无需付费。长期数据（怪物、PC、动作、能力等）安全地存储在浏览器的 IndexedDB 中；战斗进行中状态为支持刷新/离线恢复，会写入浏览器 localStorage，完全由你掌控。

核心理念：**快速、私密、高度可定制**

### 数据边界 / 持久化策略

- **长期数据**：IndexedDB（Dexie）—— 怪物/PC/动作/能力/怪物组合等
- **战斗进行中**：localStorage（键 `dnd-battle-state`）—— 支持刷新恢复
- **备份**：JSON 导入/导出（导入会清空并替换上述长期数据）

---

## 核心特性

### 📦 全功能数据库
- **怪物库**：支持按名称、CR、类型筛选
- **PC角色库**：管理玩家角色
- **动作库**：模块化的攻击、法术、能力，方便复用

### ⚔️ 自动化战斗流程
- **先攻管理**：一键掷先攻并自动排序，支持拖拽调整
- **自动化动作执行**：
  - 自动完成命中检定（支持优劣势）
  - 智能判定重击/大失败
  - 自动计算伤害
  - 自动应用易伤、抗性和免疫
- **豁免检定**：完善的范围伤害处理流程
- **状态管理**：自动追踪状态持续回合和动作冷却
- **虚假生命（临时生命值）**：可为单位设置临时生命，扣血时将优先消耗，值为0时自动隐藏

### 🎭 智能状态/条件系统
- **自动优势/劣势计算**：根据攻击者和目标的状态自动判定
  - 攻击者：中毒、束缚、倒地、目盲 → 劣势
  - 攻击者：隐形 → 优势
  - 目标：目盲、束缚、麻痹、石化、震慑、昏迷 → 攻击者获得优势
  - 目标：隐形 → 攻击者获得劣势
  - 优势与劣势相互抵消（不比较数量）
- **魅惑限制**：被魅惑时无法对魅惑源使用攻击动作，目标列表显示"无法选中"
- **豁免自动失败**：麻痹/石化/震慑/昏迷状态下，STR/DEX豁免自动失败并显示标注
- **豁免劣势指示**：力竭3级+目标在豁免结果选择器中显示"豁免劣势(力竭)"
- **状态免疫生效**：在生物编辑器勾选“状态免疫”后，该单位不会获得对应状态（战斗中手动添加、动作命中附带状态均会拦截，含力竭各等级；免疫选项与条件系统自动同步）
- **DM强制覆盖**：四档选项完全控制攻击检定
  - 自动：系统根据状态计算，触发交互式弹窗
  - 强制优势/劣势：跳过弹窗，直接使用指定模式
  - 强制普通：跳过弹窗，使用普通骰
- **交互式判定弹窗**：
  - 倒地目标：询问是否在5尺内（近战优势/远程劣势）
  - 恐慌状态：询问恐惧源是否在视线内
  - 麻痹/昏迷：命中后询问是否在5尺内（判定重击）
- **力竭等级效果**：
  - 3级+：攻击检定和豁免检定劣势
  - 4级+：HP上限减半（移除后自动恢复）
  - 6级：死亡确认弹窗（取消则回退到5级）
- **状态标签红框**：需要DM判断的状态（目盲、魅惑、耳聋、恐慌、擒抱、隐形、束缚、力竭）显示红色边框提醒
- **石化全抗性**：石化目标受到的所有伤害自动减半
- **目标列表徽标**：
  - 麻痹/昏迷：绿色"5尺内重击"
  - 倒地：白色"5尺优势/远程劣势"
  - 石化：红色"全抗性+免毒"

### 🎨 深度定制
- **生物编辑器**：从基础属性到伤害抗性，完全可定制
- **头像与背景**：支持图片上传和裁剪，增强视觉体验
- **战斗特效**：重击、大失败等关键检定带有全屏动画通知
- **规则书式展示面板（Statblock）**：查看面板使用标题/副标题、两行六维、分区条目等官方风格排版；动作支持按栏目分区展示（特殊能力/动作/反应/附赠动作/传奇动作）

### 🔒 本地优先，离线可用
- **数据安全**：所有信息存储在本地，不上传服务器
- **PWA支持**：可安装到桌面或手机，完全支持离线使用
- **数据备份**：通过 JSON 文件导入/导出

### 🚀 高效操作
- **快捷键**：双击 `D` 快速投骰，双击 `A` 执行当前动作，双击 `→` / `←` 切换回合；在全屏编辑/查看界面中双击 `空格` 保存并关闭；双击 `Q` 关闭最上层可关闭界面（若最上层无关闭入口则无效）
- **怪物组合**：预设遭遇组合，一键添加整队敌人
- **便捷交互**：多选目标、一键清空等常用操作

### 🎯 战斗视觉增强
- **图片裁剪**：支持背景图矩形裁剪和头像圆形裁剪，增强视觉体验
- **战斗特效**：重击、大失败、命中/未命中等关键检定带有全屏动画通知
- **生物详情查看**：战斗中可全屏查看单位详细信息并临时编辑
- **通知系统**：Toast消息提示和战斗结果展示

---

## 快速开始

### 🌐 在线使用（推荐）

访问线上地址：[**https://tyyf-dnd-helper.pages.dev/**](https://tyyf-dnd-helper.pages.dev/)

**建议安装为桌面应用：**
- **PC端 (Chrome/Edge)**：点击地址栏的"安装"图标
- **移动端**：使用浏览器的"添加到主屏幕"功能

### 🧪 快速体验：虚假生命
1. 进入“战斗系统”页面，添加任意参战单位
2. 在右侧“战场总览 · 目标选择器”中，找到该单位并点击 `HP`
3. 在“编辑HP”窗口中，输入“虚假生命”，点击 `刷新`
4. 对该单位造成伤害：虚假生命会优先被消耗，剩余伤害再扣除HP

### 💻 本地部署

```bash
# 克隆仓库
git clone https://github.com/tianyouyingfan/local_simple_dnd_tool.git

# 进入目录
cd local_simple_dnd_tool

# 启动本地静态服务器（推荐）
npx http-server -p 8080 -o

# 或（备选）
npx live-server --port=8080
```

- 也可以使用 VS Code 的 Live Server 插件启动
- 不建议直接双击打开 `index.html`（部分能力可能受浏览器安全策略影响）

---

## 使用指南

### 1. 怪物库

**浏览与筛选**
- 按名称搜索、CR筛选、类型筛选

**创建/编辑怪物**
1. 点击"新建怪物"或"编辑"进入全屏编辑器
2. **基础信息**：设置头像、背景、名称、CR、AC、HP（平均与骰表达式）、速度等
3. **展示信息（用于规则书式副标题）**：体型、阵营、生物类型文本、子类/括号文本
3. **属性设置**：配置六大属性，调整值自动计算
4. **抗性配置**：添加伤害类型和状态的抗性/易伤/免疫；勾选“状态免疫”后，战斗中将无法被施加对应状态
5. **动作工作台（右侧面板）**：
   - 在“私有动作”中创建/编辑/删除该怪物的私有动作
   - 在动作编辑器中可设置“栏目”：自动（按类型推断）/特殊能力/动作/反应/附赠动作/传奇动作，并可填写“描述/触发/补充说明”
   - 在“动作库”中把公共动作复制到当前怪物
   - 在“能力池”中把能力转为动作/能力条目添加到当前怪物
6. **CR调整**：实验性功能，自动调整怪物属性匹配目标CR
7. **保存选项**：
   - "更改并关闭"：覆盖原数据
   - "另存为自定义"：创建新怪物

### 2. PC角色库与动作库

- **PC角色库**：管理玩家角色，支持自定义头像、特性与私有动作；编辑器为全屏布局，右侧动作工作台与怪物一致
- **PC 描述行（用于规则书式副标题）**：在 PC 编辑器编辑模式填写“描述行”，查看模式将以斜体副标题显示
- **动作库**：全局动作模板库；默认以高密度网格展示（横向铺满自动换行），点击“新建/编辑”后进入左右分屏编辑（可随时退出编辑）
  - **动作栏目（Section）**：动作可标记为“反应/附赠动作/传奇动作”等栏目，用于在 Statblock 中分区展示；未设置栏目时将按类型自动推断（utility→特殊能力，其余→动作）
  - **退出方式**：右上“退出编辑”按钮；或双击 `空格` 保存并退出；或双击 `Q` 关闭最上层可关闭界面
  - **注意**：在动作库编辑未保存时切换到其它页面，会自动退出编辑（不保存）

### 3. 快捷键操作

- **双击 `D` 键**：打开快速投骰窗口，支持任意骰子表达式
- **双击 `A` 键**：在战斗界面中执行当前选择的动作（等同点击“执行”）
- **双击 `→` 键**：切换到下一个战斗单位
- **双击 `←` 键**：切换到上一个战斗单位
- **双击 `空格` 键**：在生物查看/编辑、动作编辑、能力编辑时，等同于“保存并关闭”
- **双击 `Q` 键**：关闭当前屏幕最上层且可关闭的界面（编辑器/弹窗/通知等）；若最上层无关闭入口则无效

提示：快捷键为 400ms 内双击触发；通常输入框/文本域聚焦时不会触发（双击 `Q` 关闭最上层界面除外）。`A` 仅在战斗页面且未打开编辑器/弹窗/投骰窗口时生效；`←/→` 会切换战斗当前行动者，建议在战斗页面使用。

### 4. 战斗系统

**战前准备**
1. **添加参战者**：从怪物库、PC库或怪物组合中添加
2. **掷先攻**：自动投掷并排序，支持手动拖拽调整

**回合流程**
1. **行动者面板**（左侧）：
   - HP管理：应用伤害/治疗
   - 状态管理：施加和追踪状态效果
   - 选择动作：查看可用动作
   
2. **目标选择**（右侧）：
   - 单击选择/取消目标
   - 支持多选
   - "选择组"快速选中整组单位
   
3. **执行动作**：
    - 设置DM强制模式（自动/强制优势/强制劣势/强制普通）
    - 点击"执行"按钮
    - 系统自动处理：
      - 攻击检定与AC比较
      - 重击/大失败判定（带全屏动画）
      - 伤害计算（含抗性处理）

**战斗通知系统**
- **重击特效**：攻击检定投出20时，显示全屏大成功动画和伤害详情
- **大失败特效**：攻击检定投出1时，显示全屏大失败动画
- **命中详情**：显示命中检定结果、伤害骰子和最终伤害计算
- **未命中提示**：显示未命中通知和检定结果
- **通知队列**：多个目标时按顺序显示，避免信息遗漏

4. **结束回合**：
   - 点击"下一个"切换行动者
   - 自动更新状态持续时间
    - 自动移除已击败单位

### 5. 怪物组合管理

**创建与管理**
1. 在怪物库点击"设置组合出战"打开组合管理器
2. 点击"+ 新建组"创建新组合
3. 为组合命名并添加怪物，可设置每个怪物的数量
4. 支持编辑、删除已有组合

**战斗应用**
1. 战斗准备阶段，从"添加参战单位"选择"从组合出战"
2. 一键添加整个怪物组合到战场
3. 同名怪物会自动命名（如"哥布林 #1"、"哥布林 #2"）

### 6. 数据管理

- **导入/导出**：JSON格式备份和恢复所有数据
- **主题切换**：切换按钮已添加到顶部栏，功能待实现

---


### 虚假生命（临时生命值）

- **设置方式**：在战斗界面中点击单位的 `HP` 按钮，输入“虚假生命”，点击 `刷新`
- **结算规则**：扣血时优先消耗虚假生命，不足部分才会扣除HP；治疗不会恢复虚假生命
- **显示规则**：虚假生命为 0 时自动隐藏以节省空间
- **覆盖规则**：当前实现为“直接设置为指定数值”，不会自动取较大值/不叠加


## 技术架构

- **前端框架**：Vue 3 + Composition API
- **状态管理**：轻量级响应式状态（ref/reactive，集中于 `js/modules/state/`）
- **数据持久化**：Dexie.js（IndexedDB 封装，集中于 `js/modules/infra/persistence/`）
- **模块化架构**：ES Modules + importmap（项目内模块统一使用裸导入）
- **离线支持**：Service Worker（预缓存入口与所有模块文件；运行时 network-first：在线更新并回填缓存、离线回退缓存；内置旧模块路径别名兼容）

## 目录结构

（已排除 `.gitignore` 中忽略的文件/目录）

```text
.
├── js/                                   # 前端源码（浏览器原生 ES Modules）
│   ├── main.js                           # Vue 应用入口/装配层（初始化、watch 持久化、模板事件绑定）
│   ├── modules/                          # 业务与基础设施模块（按职责分层：domain/infra/state/shared...）
│   │   ├── app/                          # 应用级编排（跨页面/跨域的装配逻辑）
│   │   │   └── keyboard-shortcuts.js     # 全局快捷键（投骰、回合切换、编辑器保存/取消等）
│   │   ├── composables/                  # 可复用组合式逻辑（use-*）
│   │   │   ├── use-computed.js           # 计算属性集合（列表过滤、参战单位分组、动作排序等）
│   │   │   ├── use-image-cropper.js      # 通用裁剪 Composable（矩形/圆形、拖拽裁剪、输出 dataURL）
│   │   │   └── use-toasts.js             # Toast 通知 Composable（写入 ui.toasts 并自动消失）
│   │   ├── domain/                       # 核心业务域逻辑
│   │   │   ├── battle/                   # 战斗域：回合、动作结算、HP/状态、目标、投骰
│   │   │   │   ├── action-execution.js   # 动作结算：命中/伤害/豁免、通知队列、自动扣血等
│   │   │   │   ├── battle-core.js        # 战斗核心：参战单位标准化、加入/先攻排序、回合推进、拖拽顺序
│   │   │   │   ├── conditions.js         # 状态/条件系统：优劣势计算、豁免判定、交互式弹窗、力竭效果
│   │   │   │   ├── hp-status.js          # HP/状态：扣血/治疗/虚假生命、状态增删、力竭HP上限处理
│   │   │   │   ├── quick-dice.js         # 快捷投骰：解析骰子表达式并展示结果
│   │   │   │   └── targeting.js          # 目标选择：单体/分组选择与清空选择
│   │   │   ├── entities/                 # 实体域：怪物/PC/动作/能力等
│   │   │   │   ├── actor-viewer.js       # 单位查看/临时编辑面板，并与动作选择联动
│   │   │   │   ├── cr-adjustment.js      # CR 调整入口（调用 utils.adjustMonsterToCR 的占位算法）
│   │   │   │   ├── entity-crud.js        # 怪物/PC/能力/动作的 CRUD 与编辑器保存逻辑
│   │   │   │   └── ui-toggles.js         # UI 开关与过滤器：类型筛选、抗性/免疫数组切换等
│   │   │   └── groups/                   # 遭遇组/怪物组合域
│   │   │       └── monster-groups.js     # 怪物组合 CRUD + 一键按数量加入战斗
│   │   ├── infra/                        # 基础设施层（与业务规则解耦）
│   │   │   └── persistence/              # 数据持久化与数据进出（IndexedDB/Dexie）
│   │   │       ├── data-loader.js        # 从 IndexedDB 加载到响应式 state，并提供演示数据载入
│   │   │       ├── db.js                 # Dexie 数据库定义/表结构 + 初始种子数据 seedIfEmpty
│   │   │       └── import-export.js      # 数据导入/导出（JSON 备份/恢复，导入会清空再写入）
│   │   ├── media/                        # 媒体处理实现
│   │   │   └── image-cropper.js          # 裁剪器实例：把 useImageCropper 绑定到 UI state 与草稿字段
│   │   ├── shared/                       # 纯工具与通用 helpers（跨域复用）
│   │   │   ├── helpers.js                # 通用 helper：安全解析、图片校验/读取、先攻排序、动作字段兼容等
│   │   │   ├── statblock.js              # 规则书式展示（Statblock）ViewModel 与格式化（纯函数）
│   │   │   └── utils.js                  # 通用工具：掷骰/伤害、能力调整值、CR 占位调整、排序等
│   │   └── state/                        # 全局状态与常量
│   │       ├── constants.js              # 常量集合（怪物类型/伤害类型/状态等）
│   │       └── state.js                  # 全局响应式状态、UI 状态、草稿模型与默认对象工厂
│   └── vendor/                           # 第三方库（本地 vendored，不走打包器）
│       ├── dexie.js                      # Dexie（IndexedDB 封装库）
│       └── vue.js                        # Vue 3（运行时）
├── .eslintrc.js                           # ESLint 规则配置（代码风格与质量约束）
├── .gitignore                             # Git 忽略规则（node_modules、IDE 配置、缓存等）
├── LICENSE.txt                            # 项目许可证（MIT License）
├── README.md                              # 项目说明文档
├── icon-192.png                           # PWA/快捷方式图标（192x192）
├── icon-512.png                           # PWA/快捷方式图标（512x512）
├── icon.ico                               # 站点 favicon
├── index.html                             # 单页入口：Vue 模板 + importmap + 加载 main.js + 注册 SW
├── manifest.json                          # PWA 清单（名称、主题色、图标、启动方式）
├── package-lock.json                      # npm 依赖锁定文件（锁定 ESLint 等开发依赖版本）
├── package.json                           # npm 配置（lint 脚本与 ESLint 开发依赖）
├── style.css                              # 全局样式（应用布局与组件样式）
└── sw.js                                  # Service Worker：预缓存静态资源与模块，实现离线访问
```

## 代码结构（modules 分层）

`js/modules/` 采用"外层按职责、内层按功能"的分层：

- `shared/`：无状态工具与通用 helpers（纯函数优先）
- `state/`：全局响应式状态与常量
- `infra/persistence/`：Dexie/IndexedDB 与数据加载、导入导出
- `domain/`：业务域逻辑
  - `battle/`：战斗流程、目标选择、HP/状态、动作结算、快速投骰、**状态/条件系统**
  - `entities/`：怪物/PC/动作/能力等实体编辑与查看
  - `groups/`：怪物组合/遭遇组管理
- `app/`：应用编排层（例如全局快捷键注册）
- `composables/`：可复用组合式逻辑（use-*）
- `media/`：图片/媒体相关逻辑

## importmap 与裸导入约定

- **项目内模块统一使用裸导入**（例如 `import { battle } from 'state'`、`import { loadAll } from 'data-loader'`），避免目录调整导致相对路径连锁修改。
- 裸导入名称与实际文件路径的映射集中维护在 `index.html` 的 `<script type="importmap">` 中。
- 新增/移动模块后，需要同步更新 `index.html` 的 importmap 与 `sw.js` 的预缓存列表，保证离线环境可用。

---
## Roadmap

- [ ] 完善主题系统实现（切换按钮已就位）
- [x] **代码重构**：`main.js` 完成全面模块化拆分
- [x] 图片裁剪功能（背景矩形/头像圆形）
- [x] 怪物组合管理系统
- [x] 战斗动画效果（重击/大失败/命中/未命中）
- [x] 快捷投骰功能（任意骰子表达式）
- [x] 生物详情查看与临时编辑
- [x] 展示面板 Statblock 排版（Actor Viewer / 怪物与PC编辑器查看模式）
- [x] **智能状态/条件系统**（完整实现）
  - [x] 优劣势自动计算与抵消
  - [x] 魅惑禁选（含来源追踪）
  - [x] 豁免自动失败（STR/DEX）
  - [x] 交互式弹窗（倒地/恐慌/麻痹/昏迷）
  - [x] 力竭等级效果（3级劣势/4级HP减半/6级死亡）
  - [x] DM强制覆盖（四档：自动/优势/劣势/普通）
  - [x] 石化全抗性
  - [x] 状态标签红框提醒
  - [x] 目标列表徽标系统
- [ ] 进一步完善怪物图鉴视图（已支持反应/附赠/传奇分区，待补齐巢穴动作等官方分区与更多字段展示）
- [ ] 改进CR调整算法，引入DMG攻防等级对照表
- [ ] 添加法术库与法术位追踪
- [ ] 战役与地图管理功能
- [ ] 移动端布局优化

---

## 贡献指南

欢迎任何形式的贡献：

- **Bug报告**：通过 GitHub Issues 提交
- **功能建议**：通过 Issues 提出想法
- **代码贡献**：
  1. Fork 仓库
  2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
  3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
  4. Push 到分支 (`git push origin feature/AmazingFeature`)
  5. 开启 Pull Request

---

## 许可协议

本项目采用 [MIT License](LICENSE.txt) 授权。

---

<div align="center">
  <p><strong>祝你的冒险旅程顺利！</strong></p>
</div>



