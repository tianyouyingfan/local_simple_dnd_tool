<div align="center">
  <img src="./icon-512.png" alt="项目Logo" width="100" />
  <h1>D&D战斗助手 (D&D Combat Assistant)</h1>
  <p>一款为DM打造的本地化D&D战斗辅助工具</p>
  
  <p>
    <img alt="Vue.js" src="https://img.shields.io/badge/Vue.js-3-4FC08D?style=for-the-badge&logo=vue.js">
    <img alt="Local-First" src="https://img.shields.io/badge/Data-Local First-F7DF1E?style=for-the-badge&logo=javascript">
    <img alt="PWA Ready" src="https://img.shields.io/badge/PWA-Ready-5A0FC8?style=for-the-badge&logo=pwa">
    <img alt="License" src="https://img.shields.io/badge/License-MIT-blue.svg?style=for-the-badge">
  </p>
</div>

---

## 简介

**D&D战斗助手**是一个纯本地化的战斗辅助工具，无需注册、无需联网、无需付费。所有数据（怪物、PC、战斗记录）都安全地存储在浏览器的 IndexedDB 中，完全由你掌控。

核心理念：**快速、私密、高度可定制**

---

## 核心特性

### 📦 全功能数据库
- **怪物库**：支持按名称、CR、类型筛选
- **PC角色库**：管理玩家角色
- **动作库**：模块化的攻击、法术、能力，方便复用

### ⚔️ 自动化战斗流程
- **先攻管理**：一键掷先攻并自动排序，支持拖拽调整
- **自动化动作执行**：
  - 自动完成命中检定（支持优劣势）
  - 智能判定重击/大失败
  - 自动计算伤害
  - 自动应用易伤、抗性和免疫
- **豁免检定**：完善的范围伤害处理流程
- **状态管理**：自动追踪状态持续回合和动作冷却
- **虚假生命（临时生命值）**：可为单位设置临时生命，扣血时将优先消耗，值为0时自动隐藏

### 🎨 深度定制
- **生物编辑器**：从基础属性到伤害抗性，完全可定制
- **头像与背景**：支持图片上传和裁剪，增强视觉体验
- **战斗特效**：重击、大失败等关键检定带有全屏动画通知

### 🔒 本地优先，离线可用
- **数据安全**：所有信息存储在本地，不上传服务器
- **PWA支持**：可安装到桌面或手机，完全支持离线使用
- **数据备份**：通过 JSON 文件导入/导出

### 🚀 高效操作
- **快捷键**：双击 `D` 快速投骰，`→` / `←` 切换回合
- **怪物组合**：预设遭遇组合，一键添加整队敌人
- **便捷交互**：多选目标、一键清空等常用操作

### 🎯 战斗视觉增强
- **图片裁剪**：支持背景图矩形裁剪和头像圆形裁剪，增强视觉体验
- **战斗特效**：重击、大失败、命中/未命中等关键检定带有全屏动画通知
- **生物详情查看**：战斗中可快速查看单位详细信息并临时编辑
- **通知系统**：Toast消息提示和战斗结果展示

---

## 快速开始

### 🌐 在线使用（推荐）

访问线上地址：[**https://tyyf-dnd-helper.pages.dev/**](https://tyyf-dnd-helper.pages.dev/)

**建议安装为桌面应用：**
- **PC端 (Chrome/Edge)**：点击地址栏的"安装"图标
- **移动端**：使用浏览器的"添加到主屏幕"功能

### 🧪 快速体验：虚假生命
1. 进入“战斗系统”页面，添加任意参战单位
2. 在右侧“战场总览 · 目标选择器”中，找到该单位并点击 `HP`
3. 在“编辑HP”窗口中，输入“虚假生命”，点击 `刷新`
4. 对该单位造成伤害：虚假生命会优先被消耗，剩余伤害再扣除HP

### 💻 本地部署

```bash
# 克隆仓库
git clone https://github.com/tianyouyingfan/local_simple_dnd_tool.git

# 进入目录
cd local_simple_dnd_tool

# 启动本地服务器（方式一）
npm install -g http-server
http-server

# 或使用 VS Code 的 Live Server 插件（方式二）
```

---

## 使用指南

### 1. 怪物库

**浏览与筛选**
- 按名称搜索、CR筛选、类型筛选

**创建/编辑怪物**
1. 点击"新建怪物"或"编辑"进入编辑器
2. **基础信息**：设置头像、背景、名称、CR、AC、HP等
3. **属性设置**：配置六大属性，调整值自动计算
4. **抗性配置**：添加伤害类型和状态的抗性/易伤/免疫
5. **动作管理**：
   - 创建私有动作
   - 从动作库添加通用能力
6. **CR调整**：实验性功能，自动调整怪物属性匹配目标CR
7. **保存选项**：
   - "更改并关闭"：覆盖原数据
   - "另存为自定义"：创建新怪物

### 2. PC角色库与动作库

- **PC角色库**：管理玩家角色，支持自定义头像和私有动作
- **动作库**：全局动作模板库，预设常用攻击、法术和能力

### 3. 快捷键操作

- **双击 `D` 键**：打开快速投骰窗口，支持任意骰子表达式
- **双击 `→` 键**：切换到下一个战斗单位
- **双击 `←` 键**：切换到上一个战斗单位

### 4. 战斗系统

**战前准备**
1. **添加参战者**：从怪物库、PC库或怪物组合中添加
2. **掷先攻**：自动投掷并排序，支持手动拖拽调整

**回合流程**
1. **行动者面板**（左侧）：
   - HP管理：应用伤害/治疗
   - 状态管理：施加和追踪状态效果
   - 选择动作：查看可用动作
   
2. **目标选择**（右侧）：
   - 单击选择/取消目标
   - 支持多选
   - "选择组"快速选中整组单位
   
3. **执行动作**：
    - 设置优势/劣势
    - 点击"执行"按钮
    - 系统自动处理：
      - 攻击检定与AC比较
      - 重击/大失败判定（带全屏动画）
      - 伤害计算（含抗性处理）

**战斗通知系统**
- **重击特效**：攻击检定投出20时，显示全屏大成功动画和伤害详情
- **大失败特效**：攻击检定投出1时，显示全屏大失败动画
- **命中详情**：显示命中检定结果、伤害骰子和最终伤害计算
- **未命中提示**：显示未命中通知和检定结果
- **通知队列**：多个目标时按顺序显示，避免信息遗漏

4. **结束回合**：
   - 点击"下一个"切换行动者
   - 自动更新状态持续时间
    - 自动移除已击败单位

### 5. 怪物组合管理

**创建与管理**
1. 在怪物库点击"设置组合出战"打开组合管理器
2. 点击"+ 新建组"创建新组合
3. 为组合命名并添加怪物，可设置每个怪物的数量
4. 支持编辑、删除已有组合

**战斗应用**
1. 战斗准备阶段，从"添加参战单位"选择"从组合出战"
2. 一键添加整个怪物组合到战场
3. 同名怪物会自动命名（如"哥布林 #1"、"哥布林 #2"）

### 6. 数据管理

- **导入/导出**：JSON格式备份和恢复所有数据
- **主题切换**：切换按钮已添加到顶部栏，功能待实现

---


### 虚假生命（临时生命值）

- **设置方式**：在战斗界面中点击单位的 `HP` 按钮，输入“虚假生命”，点击 `刷新`
- **结算规则**：扣血时优先消耗虚假生命，不足部分才会扣除HP；治疗不会恢复虚假生命
- **显示规则**：虚假生命为 0 时自动隐藏以节省空间
- **覆盖规则**：当前实现为“直接设置为指定数值”，不会自动取较大值/不叠加

## 技术架构

- **前端框架**：Vue 3 + Composition API
- **状态管理**：轻量级响应式状态管理（reactive/ref）
- **数据持久化**：Dexie.js (IndexedDB 封装)
- **模块化架构**：基于 ES Modules 的清晰分层架构（18+ 独立功能模块）
- **离线支持**：Service Worker 实现 PWA 离线功能
- **图片处理**：Canvas API实现图片裁剪与预览，支持矩形和圆形裁剪
- **快捷键系统**：双击检测与事件防抖，避免与输入框冲突
- **通知系统**：Toast消息队列和全屏动画通知队列管理
- **拖拽排序**：原生HTML5拖拽API实现先攻序列手动调整

---

## Roadmap

- [ ] 完善主题系统实现（切换按钮已就位）
- [x] **代码重构**：`main.js` 完成全面模块化拆分
- [x] 图片裁剪功能（背景矩形/头像圆形）
- [x] 怪物组合管理系统
- [x] 战斗动画效果（重击/大失败/命中/未命中）
- [x] 快捷投骰功能（任意骰子表达式）
- [x] 生物详情查看与临时编辑
- [ ] 优化怪物图鉴视图，模仿官方排版
- [ ] 改进CR调整算法，引入DMG攻防等级对照表
- [ ] 添加法术库与法术位追踪
- [ ] 战役与地图管理功能
- [ ] 移动端布局优化

---

## 贡献指南

欢迎任何形式的贡献：

- **Bug报告**：通过 GitHub Issues 提交
- **功能建议**：通过 Issues 提出想法
- **代码贡献**：
  1. Fork 仓库
  2. 创建特性分支 (`git checkout -b feature/AmazingFeature`)
  3. 提交更改 (`git commit -m 'Add some AmazingFeature'`)
  4. Push 到分支 (`git push origin feature/AmazingFeature`)
  5. 开启 Pull Request

---

## 许可协议

本项目采用 [MIT License](LICENSE.txt) 授权。

---

<div align="center">
  <p><strong>祝你的冒险旅程顺利！</strong></p>
</div>