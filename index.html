<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8" />
    <title>D&Dæˆ˜æ–—åŠ©æ‰‹</title>
    <link rel="stylesheet" href="style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0F1012">
    <link rel="icon" href="./icon.ico">
<body class="loading">
    <div class="loader"></div>
    <div id="app" class="app" v-cloak>
        <header>
            <div class="topbar">
                <div class="brand">
                    <div class="dot"></div>
                    <div>è·‘å›¢è¾…åŠ©å·¥å…·</div>
                </div>
                <nav class="tabs">
                    <div class="tab" :class="{active: route==='monsters'}" @click="route='monsters'">æ€ªç‰©åº“</div>
                    <div class="tab" :class="{active: route==='pcs'}" @click="route='pcs'">PCè§’è‰²åº“</div>
                    <div class="tab" :class="{active: route==='actions'}" @click="route='actions'">åŠ¨ä½œåº“</div>
                    <div class="tab" :class="{active: route==='battle'}" @click="route='battle'">æˆ˜æ–—</div>
                    <div class="tab" :class="{active: route==='settings'}" @click="route='settings'">å¯¼å…¥/å¯¼å‡º</div>
                </nav>
                <div class="spacer"></div>
                <button class="btn" @click="toggleTheme">åˆ‡æ¢ä¸»é¢˜</button>
            </div>
        </header>

        <main>
            <!-- æ€ªç‰©åº“åˆ—è¡¨é¡µ -->
            <section v-if="route==='monsters'">
                <div class="toolbar">
                    <input class="input" style="min-width:240px" v-model="monsterFilters.keyword"
                        placeholder="æŒ‰åç§°æœç´¢..." />
                    <select v-model="monsterFilters.cr" class="input">
                        <option value="">CRï¼ˆå…¨éƒ¨ï¼‰</option>
                        <option v-for="cr in crOptions" :key="cr" :value="cr">{{cr}}</option>
                    </select>
                    <div class="row">
                        <span class="muted small">ç±»å‹ç­›é€‰ï¼š</span>
                        <span v-for="t in monsterTypes" :key="t" class="chip"
                            :class="{active: monsterFilters.types.includes(t)}" @click="toggleTypeFilter(t)">{{
                            translateType(t) }}</span>
                    </div>
                    <div class="spacer"></div>
                    <button class="btn" @click="openMonsterEditor()">+ æ–°å»ºæ€ªç‰©</button>
                    <button class="btn" @click="openAbilityPool()">èƒ½åŠ›æ± </button>
                    <button class="btn" @click="seedDemo">è½½å…¥æ¼”ç¤ºæ•°æ®</button>
                    <button class="btn" @click="openGroupManager()">è®¾ç½®ç»„åˆå‡ºæˆ˜</button>
                </div>

                <div class="grid cards">
                    <div class="card" v-for="m in filteredMonsters" :key="m.id">
                        <div class="row">
                            <div class="avatar">
                                <img v-if="m.avatar" :src="m.avatar" alt="Avatar">
                                <span v-else>ğŸ§Ÿ</span>
                            </div>
                            <div class="title">{{m.name}}</div>
                            <span class="pill right mono">CR {{m.cr}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill">AC {{m.ac}}</span>
                            <span class="pill">HP {{m.hp?.average ?? m.hp ?? 'â€”'}}</span>
                            <span class="pill">{{(m.type||[]).map(translateType).join(', ') || 'æœªåˆ†ç±»'}}</span>
                            <span class="pill" v-if="m.isCustom">è‡ªå®šä¹‰</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="openMonsterEditor(m)">è¯¦æƒ…/ä¼ªç¼–è¾‘</button>
                            <button class="btn" @click="addToBattleFromMonster(m)">åŠ å…¥æˆ˜æ–—</button>
                            <div class="spacer"></div>
                            <button class="btn" @click="duplicateMonster(m)">å¤åˆ¶</button>
                            <button class="btn danger" @click="deleteMonster(m.id)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PC è§’è‰²åº“ -->
            <section v-if="route==='pcs'">
                <div class="toolbar">
                    <button class="btn" @click="openPCEditor()">+ æ–°å»ºPC</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="pc in pcs" :key="pc.id">
                        <div class="row">
                            <div class="avatar">
                                <img v-if="pc.avatar" :src="pc.avatar" alt="Avatar">
                                <span v-else>ğŸ§</span>
                            </div>
                            <div class="title">{{pc.name}}</div>
                            <span class="pill right">AC {{pc.ac}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill">HP {{pc.hpCurrent}}/{{pc.hpMax}}</span>
                            <span class="pill">æ• {{mod(pc.abilities.dex)}} åŠ› {{mod(pc.abilities.str)}} ä½“
                                {{mod(pc.abilities.con)}}</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="openPCEditor(pc)">ç¼–è¾‘</button>
                            <button class="btn" @click="addToBattleFromPC(pc)">åŠ å…¥æˆ˜æ–—</button>
                            <div class="spacer"></div>
                            <button class="btn danger" @click="deletePC(pc.id)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- åŠ¨ä½œåº“ -->
            <section v-if="route==='actions'">
                <div class="toolbar">
                    <button class="btn" @click="openActionEditor()">+ æ–°å»ºåŠ¨ä½œ</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="action in actions" :key="action.id">
                        <div class="row">
                            <div class="title">{{action.name}}</div>
                            <span class="pill right">{{action.type}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill" v-if="action.attackBonus">æ”»å‡»+{{action.attackBonus}}</span>
                            <span class="pill" v-if="action.range">è·ç¦»: {{action.range}}</span>
                            <span class="pill" v-if="action.damages?.length">{{ formatDamages(action.damages) }}</span>
                            <span class="pill" v-if="action.range">è·ç¦»: {{action.range}}</span>
                            <span class="pill" v-if="action.saveDC">è±å… DC{{action.saveDC}} {{action.saveAbility}}</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="openActionEditor(action)">ç¼–è¾‘</button>
                            <div class="spacer"></div>
                            <button class="btn danger" @click="deleteAction(action.id)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- æˆ˜æ–—ä¸»ç•Œé¢ï¼ˆä¸‰åŒºå¸ƒå±€ï¼‰ -->
            <section v-if="route==='battle'">
                <div class="battle">
                    <!-- é¡¶éƒ¨å…ˆæ”»åºåˆ—æ¡: æ ¹æ®çŠ¶æ€æ¡ä»¶æ¸²æŸ“ -->

                    <!-- æŸ¥çœ‹æ¨¡å¼ (v-if) -->
                    <div v-if="!ui.isEditingInitiative" class="initiative-bar hscroll" @dragover.prevent>
                        <div v-for="(p, idx) in battle.participants" :key="p.uid" class="init-tile"
                            :class="{'active-turn-highlight': currentActor && p.uid === currentActor.uid, 'just-joined': p.justJoined}"
                            :ref="(el) => { if (el) participantTiles.set(p.uid, el); }" draggable="true"
                            @dragstart="onDragStart(idx)" @drop="onDrop(idx)">
                            <div class="init-header">
                                <div class="drag-handle" title="æ‹–æ‹½è°ƒæ•´é¡ºåº">â ¿</div>
                                <div class="col">
                                    <div style="font-weight:700">{{p.name}}</div>
                                    <div class="small muted">å…ˆæ”» {{p.initiativeRoll ?? 'â€”'}} + {{p.initiativeModifier ??
                                        'â€”'}}</div>
                                </div>
                                <div class="spacer"></div>
                                <div class="hp">{{p.hpCurrent}}/{{p.hpMax}}</div>
                            </div>
                            <div class="statuses">
                                <span v-for="s in p.statuses" :key="s.id" class="status"
                                    :data-tooltip="s.name + ' å‰©ä½™'+ s.rounds +'å›åˆ'">
                                    {{s.icon || 'â³'}} {{s.name}} ({{s.rounds}})
                                </span>
                            </div>
                            <div class="row">
                                <div class="avatar">
                                    <img v-if="p.avatar" :src="p.avatar" alt="Avatar">
                                    <span v-else>ğŸ¯</span>
                                </div>
                                <button class="btn small" @click="setCurrentActor(p.uid)">è®¾ä¸ºå½“å‰</button>
                                <button class="btn small" @click="removeParticipant(p.uid)">ç§»é™¤</button>
                            </div>
                            <div class="small muted" v-if="p.tempHp > 0" style="color: var(--primary); width: 100%; text-align: right;">å‰©ä½™è™šå‡ç”Ÿå‘½: {{p.tempHp}}</div>
                        </div>
                    </div>

                    <!-- ç¼–è¾‘æ¨¡å¼ (v-else) -->
                    <div v-else class="initiative-editor-list hscroll" @dragover.prevent>
                        <div v-for="(p, idx) in battle.participants" :key="p.uid" class="compact-tile"
                            :class="{'active-turn-highlight': currentActor && p.uid === currentActor.uid, 'just-joined': p.justJoined}"
                            draggable="true" @dragstart="onDragStart(idx)" @drop="onDrop(idx)">
                            <div class="drag-handle" title="æ‹–æ‹½è°ƒæ•´é¡ºåº">â ¿</div>
                            <div class="avatar">
                                <img v-if="p.avatar" :src="p.avatar" alt="Avatar">
                                <span v-else>ğŸ¯</span>
                            </div>
                            <div class="compact-tile-name">{{ p.name }}</div>
                            <div class="spacer"></div>
                            <div class="compact-tile-init">{{ p.initiative ?? 'â€”' }}</div>
                        </div>
                    </div>

                    <!-- ä¸‹æ–¹å·¦å³ä¸¤ä¾§ï¼ˆå„50%ï¼‰ -->
                    <div class="battle-grid">
                        <!-- å·¦ï¼šå½“å‰è¡ŒåŠ¨è€…è¯¦æƒ… -->
                        <div class="pane">
                            <div class="sticky-toolbar row">
                                <button class="btn" @click="promptAddParticipants()">+ æ·»åŠ å•ä½</button>
                                <button class="btn" @click="rollInitiative()">æ·å…ˆæ”»</button>
                                <button class="btn" @click="prevTurn()">ä¸Šä¸€ä¸ª</button>
                                <button class="btn primary" @click="nextTurn()">ä¸‹ä¸€ä¸ª</button>
                                <button class="btn warn" @click="resetBattle()">åˆå§‹åŒ–æˆ˜æ–—</button>
                                <!-- æ–°å¢: ç¼–è¾‘æ¨¡å¼åˆ‡æ¢æŒ‰é’® -->
                                <button class="btn" @click="ui.isEditingInitiative = !ui.isEditingInitiative">
                                    {{ ui.isEditingInitiative ? 'å®Œæˆç¼–è¾‘' : 'ç¼–è¾‘å…ˆæ”»åºåˆ—' }}
                                </button>
                                <span class="pill right">å›åˆï¼š{{battle.round}}</span>
                            </div>
                            <template v-if="currentActor">
                                <div class="actor-header">
                                    <div class="avatar" style="width:40px;height:40px;font-size:20px; cursor: pointer;"
                                        @click="openActorViewer(currentActor)">
                                        <img v-if="currentActor.avatar" :src="currentActor.avatar" alt="Avatar">
                                        <span v-else>ğŸ¯</span>
                                    </div>
                                    <div class="col">
                                        <div class="title" style="cursor: pointer;"
                                            @click="openActorViewer(currentActor)">{{currentActor.name}}</div>
                                        <div class="muted small">AC {{currentActor.ac}} Â· HP
                                            {{currentActor.hpCurrent}}/{{currentActor.hpMax}}</div>
                                    </div>
                                    <div class="spacer"></div>
                                    <div class="row">
                                        <input class="input small mono" style="width:120px" v-model.number="hpDelta"
                                            placeholder="+/-HP">
                                        <button class="btn small"
                                            @click="applyHPDelta(currentActor, hpDelta)">åº”ç”¨</button>
                                        <button class="btn small"
                                            @click="applyHPDelta(currentActor, Math.floor(hpDelta/2))">åŠä¼¤</button>
                                        <button class="btn small"
                                            @click="applyHPDelta(currentActor, hpDelta*2)">åŒå€</button>
                                        <button class="btn small ok"
                                            @click="applyHPDelta(currentActor, Math.abs(hpDelta))">æ²»ç–—</button>
                                    </div>
                                </div>

                                <div class="hl"></div>
                                <div class="section-title">å…­å¤§å±æ€§</div>
                                <div class="ability-grid">
                                    <div class="ability" v-for="(v,k) in currentActor.abilities" :key="k">
                                        <div class="muted small">{{k.toUpperCase()}}</div>
                                        <div style="font-weight:700">{{v}} ({{mod(v)>=0?'+':''}}{{mod(v)}})</div>
                                    </div>
                                </div>

                                <div class="hl"></div>
                                <div class="section-title">åŠ¨ä½œ/èƒ½åŠ›</div>
                                <div class="actions-list">
                                    <button class="btn" v-for="a in sortedCurrentActorActions" :key="a.id"
                                        @click="selectAction(a)" :disabled="a.cooldown > 0">
                                        {{a.name}}
                                        <span v-if="a.cooldown > 0" class="muted small">(å†·å´ä¸­ {{a.cooldown}})</span>
                                        <span v-else class="muted small">({{a.type}})</span>
                                    </button>
                                    <span class="muted small"
                                        v-if="!currentActor.actions?.length">æš‚æ— åŠ¨ä½œï¼ˆTODOï¼šåœ¨æ€ªç‰©/PCç¼–è¾‘å¤„æ·»åŠ åŠ¨ä½œï¼‰</span>
                                </div>

                                <template v-if="ui.selectedAction">
                                    <div class="hl"></div>
                                    <div class="row">
                                        <div class="section-title">è‡ªåŠ¨åŒ–æ”»å‡»æµç¨‹</div>
                                        <span class="pill">æ¨¡å¼</span>
                                        <select class="input" v-model="ui.rollMode">
                                            <option value="normal">æ— </option>
                                            <option value="adv">ä¼˜åŠ¿</option>
                                            <option value="dis">åŠ£åŠ¿</option>
                                        </select>
                                        <span class="pill">è‡ªåŠ¨æ‰£è¡€</span>
                                        <input type="checkbox" v-model="ui.autoApplyDamage">
                                        <div class="spacer"></div>
                                        <button class="btn" @click="runAction()" :disabled="ui.actionOnCooldown">
                                            {{ ui.actionOnCooldown ? 'æ‰§è¡Œä¸­...' : `æ‰§è¡Œ ${ui.selectedAction.name}` }}
                                        </button>
                                        <button class="btn ghost" @click="ui.selectedAction=null">å–æ¶ˆ</button>
                                    </div>
                                    <div class="row small muted">æç¤ºï¼šåœ¨å³ä¾§æˆ˜åœºæ€»è§ˆé¢æ¿ä¸­å¤šé€‰ç›®æ ‡</div>
                                    <div class="hl"></div>
                                    <div class="log" style="min-height:100px">{{ui.log || 'æˆ˜æ–—æ—¥å¿—å°†æ˜¾ç¤ºäºæ­¤'}}</div>
                                </template>

                                <div class="hl"></div>
                                <div class="section-title">çŠ¶æ€ç®¡ç†</div>
                                <div class="row">
                                    <button class="btn" @click="openStatusPicker(currentActor)">+ æ–½åŠ çŠ¶æ€</button>
                                    <div class="spacer"></div>
                                    <span class="muted small">çŠ¶æ€åˆ°æœŸåå°†è‡ªåŠ¨ç§»é™¤ï¼ˆå›åˆå¼€å§‹æ—¶ç»“ç®—ï¼‰</span>
                                </div>
                                <div class="row" style="margin-top:8px;flex-wrap:wrap;gap:8px">
                                    <span v-for="s in currentActor.statuses" :key="s.id" class="status">
                                        {{s.icon || 'â³'}} {{s.name}} ({{s.rounds}})
                                        <button class="btn small ghost"
                                            @click="removeStatus(currentActor, s.id)">ç§»é™¤</button>
                                    </span>
                                </div>
                            </template>
                            <div v-else class="placeholder">è¯·é€‰æ‹©æˆ–æ·»åŠ è¡ŒåŠ¨è€…</div>
                        </div>

                        <!-- å³ï¼šæˆ˜åœºæ€»è§ˆ -->
                        <div class="pane">
                            <div class="row">
                                <div class="section-title">æˆ˜åœºæ€»è§ˆ Â· ç›®æ ‡é€‰æ‹©å™¨</div>
                                <div class="spacer"></div>
                                <button class="btn" @click="selectNone()">æ¸…é™¤é€‰æ‹©</button>
                            </div>
                            <div class="hl"></div>
                            <div v-for="g in groupedParticipants" :key="g.groupName" style="margin-bottom: 12px;">
                                <div class="row">
                                    <div class="title">{{g.groupName}}</div>
                                    <div class="spacer"></div>
                                    <button class="btn small" @click="toggleSelectGroup(g)">é€‰æ‹©ç»„</button>
                                </div>
                                <div class="hl"></div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div v-for="p in g.members" :key="p.uid" class="target-card"
                                        :class="{selected: ui.selectedTargets.includes(p.uid)}"
                                        @click="toggleTarget(p.uid)">
                                        <div class="row" style="width: 100%; align-items: center;">
                                            <div class="avatar" @click.stop="openQuickDamageEditor(p)"
                                                style="cursor: pointer;">
                                                <img v-if="p.avatar" :src="p.avatar" alt="Avatar">
                                                <span v-else>ğŸ¯</span>
                                            </div>
                                            <div style="font-weight:700" @click.stop="openQuickDamageEditor(p)"
                                                style="cursor: pointer;">{{p.name}}</div>
                                            <div class="spacer"></div>
                                            <div class="hp">{{p.hpCurrent}}/{{p.hpMax}}</div>
                                            <transition name="toast-fade">
                                                <div v-if="p.tempHp > 0" class="hp" style="margin-left: 8px; white-space: nowrap;">è™šå‡ç”Ÿå‘½ï¼š{{p.tempHp}}</div>
                                            </transition>
                                            <div class="small muted" style="min-width: 50px; margin-left: 8px;">AC
                                                {{p.ac}}</div>
                                            <span class="pill">å…ˆæ”» {{p.initiative ?? 'â€”'}}</span>
                                            <button class="btn small" @click.stop="openHPEditor(p)">HP</button>
                                            <button class="btn small" @click.stop="openStatusPicker(p)">+ çŠ¶æ€</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="hl"></div>
                            <div class="danger-zone small">
                                TODOï¼šæˆ˜åœºæ•´ä½“æ ‡è®°/æ‰‹åŠ¨åˆ†ç»„ä¸é‡å‘½åç®¡ç†äº¤äº’å¢å¼ºï¼ˆç›®å‰æŒ‰æ€ªç‰©/PCè‡ªåŠ¨æˆç»„ï¼Œå¯åœ¨å•ä½è¯¦æƒ…é‡å‘½ååˆ†ç»„ï¼‰
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- å¯¼å…¥/å¯¼å‡º -->
            <section v-if="route==='settings'">
                <div class="card">
                    <div class="section-title">æ•°æ®å¯¼å…¥/å¯¼å‡ºï¼ˆJSONï¼Œå…¨é‡ï¼‰</div>
                    <div class="row">
                        <button class="btn" @click="exportAll()">å¯¼å‡ºå…¨éƒ¨æ•°æ®</button>
                        <input type="file" ref="file" accept="application/json" @change="importAll" hidden>
                        <button class="btn" @click="$refs.file.click()">å¯¼å…¥æ•°æ®</button>
                        <div class="spacer"></div>
                        <span class="muted">æ‰€æœ‰æ•°æ®å‡å­˜å‚¨äºæµè§ˆå™¨ IndexedDBï¼Œæ”¯æŒç¦»çº¿ä½¿ç”¨</span>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="card">
                    <div class="section-title">å¿«æ·é”®ä¸€è§ˆ</div>
                    <div class="placeholder">
                        - åŒå‡» Dï¼šæ‰“å¼€å¿«é€ŸæŠ•éª°<br>
                        - åŒå‡» â†ï¼šåˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªå›åˆå•ä½<br>
                        - åŒå‡» â†’ï¼šåˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªå›åˆå•ä½<br>
                        - åŒå‡» ç©ºæ ¼ï¼šåœ¨ç”Ÿç‰©æŸ¥çœ‹/ç¼–è¾‘ã€åŠ¨ä½œç¼–è¾‘ã€èƒ½åŠ›ç¼–è¾‘æ—¶ï¼Œä¿å­˜å¹¶å…³é—­<br>
                        - åŒå‡» Qï¼šåœ¨ç”Ÿç‰©æŸ¥çœ‹/ç¼–è¾‘ã€åŠ¨ä½œç¼–è¾‘ã€èƒ½åŠ›ç¼–è¾‘æ—¶ï¼Œå…³é—­ï¼ˆä¸ä¿å­˜ï¼‰<br>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="card">
                    <div class="section-title">é¡¹ç›®è¯´æ˜/å ä½</div>
                    <div class="placeholder">
                        - TODOï¼šå®Œæ•´çš„ã€Šæ€ªç‰©å›¾é‰´ã€‹æ ·å¼æ’ç‰ˆï¼ˆæŒ‰å®˜æ–¹é£æ ¼ï¼‰<br>
                        - TODOï¼šCR ä¸€é”®è°ƒæ•´ç®—æ³•ç»†èŠ‚å®Œå–„ä¸â€œä¼¤å®³/è½®â€åç®—ä¼¤å®³éª°<br>
                        - TODOï¼šæ›´ä¸°å¯Œçš„çŠ¶æ€å›¾æ ‡ä¸è¯´æ˜ã€æ‚¬æµ®æç¤º<br>
                    </div>
                </div>
            </section>
        </main>

        <!-- æ¨¡æ€ï¼šç”Ÿç‰©è¯¦æƒ…æŸ¥çœ‹å™¨ -->
        <div class="modal-mask" v-if="ui.actorViewer.open">
            <div class="modal" v-if="ui.actorViewer.actor">
                <div class="row">
                    <div class="title">ç”Ÿç‰©è¯¦æƒ…</div>
                    <div class="spacer"></div>
                    <button class="btn" v-if="!ui.actorViewer.isEditing" @click="startActorViewerEdit">ç¼–è¾‘</button>
                    <button class="btn ok" v-if="ui.actorViewer.isEditing" @click="saveActorViewerChanges">ä¿å­˜</button>
                    <button class="btn" v-if="ui.actorViewer.isEditing" @click="cancelActorViewerEdit">å–æ¶ˆ</button>
                    <button class="btn" @click="ui.actorViewer.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>

                <!-- PC æŸ¥çœ‹æ¨¡å¼ -->
                <template v-if="ui.actorViewer.actor.type === 'pc'">
                    <div class="monster-view-container" style="position: relative;">
                        <!-- èƒŒæ™¯å›¾ -->
                        <img v-if="ui.actorViewer.actor.backgroundImage" :src="ui.actorViewer.actor.backgroundImage"
                            style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; z-index: 1; border-radius: var(--radius);">
                        
                        <!-- å†…å®¹å®¹å™¨ -->
                        <div style="position: relative; z-index: 2; padding: 12px;">
                            <div class="row">
                                <div class="avatar" style="width: 60px; height: 60px; font-size: 30px;">
                                    <img v-if="ui.actorViewer.actor.avatar" :src="ui.actorViewer.actor.avatar" alt="Avatar"
                                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                    <span v-else>ğŸ§</span>
                                </div>
                                <div class="col">
                                    <h2 style="margin: 0;">{{ ui.actorViewer.actor.name }}</h2>
                                    <div class="kpi muted small" style="margin-top: 8px;">
                                        <span class="pill" v-if="!ui.actorViewer.isEditing">AC
                                            {{ui.actorViewer.actor.ac}}</span>
                                        <span class="pill" v-else>AC <input type="number" class="inline-input"
                                            v-model.number="ui.actorViewer.draft.ac"></span>
                                        <span class="pill" v-if="!ui.actorViewer.isEditing">HP
                                            {{ui.actorViewer.actor.hpCurrent}} /
                                            {{ui.actorViewer.actor.hpMax}}</span>
                                        <span class="pill" v-else>HP <input type="number" class="inline-input"
                                            v-model.number="ui.actorViewer.draft.hpCurrent"> /
                                            <input type="number" class="inline-input"
                                            v-model.number="ui.actorViewer.draft.hpMax"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="hl"></div>
                            <div class="section-title">å…­å¤§å±æ€§</div>
                            <div class="ability-grid">
                                <div class="ability" v-for="(v,k) in ui.actorViewer.actor.abilities" :key="k">
                                    <div class="muted small">{{k.toUpperCase()}}</div>
                                    <div v-if="!ui.actorViewer.isEditing" style="font-weight:700">{{v}}
                                        ({{mod(v)>=0?'+':''}}{{mod(v)}})</div>
                                    <div v-else>
                                        <input type="number" class="inline-input"
                                            v-model.number="ui.actorViewer.draft.abilities[k]">
                                        ({{mod(ui.actorViewer.draft.abilities[k])>=0?'+':''}}{{mod(ui.actorViewer.draft.abilities[k])}})
                                    </div>
                                </div>
                            </div>
                            <div class="hl"></div>
                            <div class="three-col">
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³æŠ—æ€§</div>
                                    <div class="muted small">{{ (ui.actorViewer.actor.resistances.damage || []).join(', ') ||
                                        'æ— ' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³æ˜“ä¼¤</div>
                                    <div class="muted small">{{ (ui.actorViewer.actor.vulnerabilities.damage || []).join(', ')
                                        || 'æ— ' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³å…ç–«</div>
                                    <div class="muted small">{{ (ui.actorViewer.actor.immunities.damage || []).join(', ') || 'æ— '
                                        }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">çŠ¶æ€å…ç–«</div>
                                    <div class="muted small">{{ (ui.actorViewer.actor.immunities.conditions || []).join(', ') ||
                                        'æ— ' }}</div>
                                </div>
                            </div>
                            <div class="hl"></div>
                            <div class="section-title">ç‰¹æ€§</div>
                            <div class="muted small"
                                style="white-space: pre-wrap; background: #1a1d21; padding: 8px; border-radius: 8px;">{{
                                ui.actorViewer.actor.features || 'æ— ' }}</div>
                            <div class="hl"></div>
                            <div class="section-title">åŠ¨ä½œ</div>
                            <div class="grid" style="gap: 8px;">
                                <div class="card" v-for="a in sortedActorViewerActions" :key="a.id"
                                    :style="['attack', 'save'].includes(a.type) ? { cursor: 'pointer' } : {}"
                                    @click="['attack', 'save'].includes(a.type) ? selectActionFromViewer(a) : null">
                                    <div class="row">
                                        <div class="title">{{ a.name }}</div>
                                        <div class="spacer"></div>
                                        <span class="tag">{{ a.type }}</span>
                                    </div>
                                    <div class="muted small" style="margin-top: 6px;">
                                        <template v-if="a.type === 'attack'">
                                            <span>æ”»å‡»+{{ a.attackBonus }}</span>,
                                            <span v-if="a.range">è·ç¦»: {{ a.range }}</span>,
                                            <span>ä¼¤å®³: {{ formatDamages(a.damages) }}</span>
                                        </template>
                                        <template v-else-if="a.type === 'save'">
                                            <span v-if="a.range">è·ç¦»: {{ a.range }}</span>,
                                            <span>è±å…DC {{ a.saveDC }} {{ a.saveAbility?.toUpperCase() }}</span>,
                                            <span>ä¼¤å®³: {{ formatDamages(a.damages) }}</span>
                                        </template>
                                        <template v-else>
                                            <span>{{ a.note || 'å®ç”¨èƒ½åŠ›' }}</span>
                                        </template>
                                    </div>
                                </div>
                                <div v-if="!ui.actorViewer.actor.actions?.length" class="placeholder small">æ— åŠ¨ä½œ</div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Monster æŸ¥çœ‹æ¨¡å¼ -->
                <template v-else>
                    <div class="monster-view-container" style="position: relative;">
                        <img v-if="ui.actorViewer.actor.backgroundImage" :src="ui.actorViewer.actor.backgroundImage"
                            style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; z-index: 1; border-radius: var(--radius);">
                        <div style="position: relative; z-index: 2; padding: 12px;">
                            <div class="row">
                                <h2 style="margin: 0;">{{ ui.actorViewer.actor.name }}</h2>
                                <div class="spacer"></div>
                                <span class="pill mono">CR {{ui.actorViewer.actor.cr}}</span>
                            </div>
                            <div class="kpi muted small" style="margin-top: 8px;">
                                <span class="pill" v-if="!ui.actorViewer.isEditing">AC
                                    {{ui.actorViewer.actor.ac}}</span>
                                <span class="pill" v-else>AC <input type="number" class="inline-input"
                                        v-model.number="ui.actorViewer.draft.ac"></span>
                                <span class="pill" v-if="!ui.actorViewer.isEditing">HP
                                    {{ui.actorViewer.actor.hpCurrent}} /
                                    {{ui.actorViewer.actor.hpMax}}</span>
                                <span class="pill" v-else>HP <input type="number" class="inline-input"
                                        v-model.number="ui.actorViewer.draft.hpCurrent"> /
                                    <input type="number" class="inline-input"
                                        v-model.number="ui.actorViewer.draft.hpMax"></span>
                                <span class="pill" v-if="!ui.actorViewer.isEditing">é€Ÿåº¦ {{(ui.actorViewer.actor.speed &&
                                    ui.actorViewer.actor.speed.walk)
                                    || '?'}}ft</span>
                                <span class="pill" v-else>é€Ÿåº¦ <input type="number" class="inline-input"
                                        v-model.number="ui.actorViewer.draft.speed.walk">ft</span>
                                <span class="pill">{{
                                    (ui.actorViewer.actor.monsterType||[]).map(translateType).join(',') || 'æœªåˆ†ç±»'
                                    }}</span>
                            </div>
                            <div class="hl"></div>
                            <div class="section-title">å…­å¤§å±æ€§</div>
                            <div class="ability-grid">
                                <div class="ability" v-for="(v,k) in ui.actorViewer.actor.abilities" :key="k">
                                    <div class="muted small">{{k.toUpperCase()}}</div>
                                    <div v-if="!ui.actorViewer.isEditing" style="font-weight:700">{{v}}
                                        ({{mod(v)>=0?'+':''}}{{mod(v)}})</div>
                                    <div v-else>
                                        <input type="number" class="inline-input"
                                            v-model.number="ui.actorViewer.draft.abilities[k]">
                                        ({{mod(ui.actorViewer.draft.abilities[k])>=0?'+':''}}{{mod(ui.actorViewer.draft.abilities[k])}})
                                    </div>
                                </div>
                            </div>
                            <div class="hl"></div>
                            <div class="three-col">
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³æŠ—æ€§</div>
                                    <div class="muted small">{{ ui.actorViewer.actor.resistances.damage.join(', ') ||
                                        'æ— ' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³æ˜“ä¼¤</div>
                                    <div class="muted small">{{ ui.actorViewer.actor.vulnerabilities.damage.join(', ')
                                        || 'æ— ' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³å…ç–«</div>
                                    <div class="muted small">{{ ui.actorViewer.actor.immunities.damage.join(', ') || 'æ— '
                                        }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">çŠ¶æ€å…ç–«</div>
                                    <div class="muted small">{{ ui.actorViewer.actor.immunities.conditions.join(', ') ||
                                        'æ— ' }}</div>
                                </div>
                            </div>
                            <div class="hl"></div>
                            <div class="section-title">ç‰¹æ®Šèƒ½åŠ›/åŠ¨ä½œ</div>
                            <div class="grid" style="gap: 8px;">
                                <div class="card" v-for="a in sortedActorViewerActions" :key="a.id"
                                    :style="['attack', 'save'].includes(a.type) ? { cursor: 'pointer' } : {}"
                                    @click="['attack', 'save'].includes(a.type) ? selectActionFromViewer(a) : null">
                                    <div class="row">
                                        <div class="title">{{ a.name }}</div>
                                        <div class="spacer"></div>
                                        <span class="tag">{{ a.type }}</span>
                                        <span class="tag" v-if="a.recharge > 0">å……èƒ½ {{ a.recharge }}</span>
                                    </div>
                                    <div class="muted small" style="margin-top: 6px;">
                                        <template v-if="a.type === 'attack'">
                                            <span>æ”»å‡»+{{ a.attackBonus }}</span>,
                                            <span v-if="a.range">è·ç¦»: {{ a.range }}</span>,
                                            <span>ä¼¤å®³: {{ formatDamages(a.damages) }}</span>
                                        </template>
                                        <template v-else-if="a.type === 'save'">
                                            <span v-if="a.range">è·ç¦»: {{ a.range }}</span>,
                                            <span>è±å…DC {{ a.saveDC }} {{ a.saveAbility?.toUpperCase() }}</span>,
                                            <span>ä¼¤å®³: {{ formatDamages(a.damages) }}</span>,
                                            <span v-if="a.onSuccess === 'half'">æˆåŠŸåˆ™åŠä¼¤</span>
                                        </template>
                                        <template v-else>
                                            <span>{{ a.note || 'å®ç”¨èƒ½åŠ›' }}</span>
                                        </template>
                                    </div>
                                </div>
                                <div v-if="!ui.actorViewer.actor.actions?.length" class="placeholder small">æ— ç‰¹æ®Šèƒ½åŠ›æˆ–åŠ¨ä½œ
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="hl"></div>
                <div class="row">
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.actorViewer.open=false">å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šæ€ªç‰©ç¼–è¾‘å™¨ -->
        <div class="modal-mask" v-if="ui.monsterEditor.open">
            <div class="modal">
                <div class="row">
                    <div class="title">æ€ªç‰©è¯¦æƒ…/ç¼–è¾‘å™¨</div>
                    <div class="spacer"></div>
                    <button class="btn"
                        @click="ui.monsterEditor.mode = ui.monsterEditor.mode === 'view' ? 'edit' : 'view'">
                        {{ ui.monsterEditor.mode === 'view' ? 'åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼' : 'åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼' }}
                    </button>
                    <button class="btn" @click="ui.monsterEditor.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>

                <!-- æŸ¥çœ‹æ¨¡å¼ -->
                <div v-if="ui.monsterEditor.mode === 'view'">
                    <div class="monster-view-container" style="position: relative;">
                        <!-- èƒŒæ™¯å›¾ -->
                        <img v-if="uiState.monsterDraft.backgroundImage" :src="uiState.monsterDraft.backgroundImage"
                            style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; z-index: 1; border-radius: var(--radius);">

                        <!-- å†…å®¹å®¹å™¨ -->
                        <div style="position: relative; z-index: 2; padding: 12px;">
                            <div class="row">
                                <!-- ä¸Šä¼ æŒ‰é’® -->
                                <input type="file" ref="bgUpload" @change="onBgImageSelect" accept="image/*" hidden>
                                <button class="btn" @click="$refs.bgUpload.click()">ä¸Šä¼ èƒŒæ™¯</button>
                                <h2 style="margin: 0;">{{ uiState.monsterDraft.name }}</h2>
                                <div class="spacer"></div>
                                <span class="pill mono">CR {{uiState.monsterDraft.cr}}</span>
                            </div>
                            <div class="kpi muted small" style="margin-top: 8px;">
                                <span class="pill">AC {{uiState.monsterDraft.ac}}</span>
                                <span class="pill">HP {{uiState.monsterDraft.hp.average}}</span>
                                <span class="pill">é€Ÿåº¦ {{uiState.monsterDraft.speed.walk}}ft</span>
                                <span class="pill">{{ (uiState.monsterDraft.type||[]).map(translateType).join(', ') ||
                                    'æœªåˆ†ç±»' }}</span>
                            </div>

                            <div class="hl"></div>

                            <div class="section-title">å…­å¤§å±æ€§</div>
                            <div class="ability-grid">
                                <div class="ability" v-for="(v,k) in uiState.monsterDraft.abilities" :key="k">
                                    <div class="muted small">{{k.toUpperCase()}}</div>
                                    <div style="font-weight:700">{{v}} ({{mod(v)>=0?'+':''}}{{mod(v)}})</div>
                                </div>
                            </div>

                            <div class="hl"></div>

                            <div class="three-col">
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³æŠ—æ€§</div>
                                    <div class="muted small">{{ uiState.monsterDraft.resistances.damage.join(', ') ||
                                        'æ— ' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³æ˜“ä¼¤</div>
                                    <div class="muted small">{{ uiState.monsterDraft.vulnerabilities.damage.join(', ')
                                        || 'æ— ' }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³å…ç–«</div>
                                    <div class="muted small">{{ uiState.monsterDraft.immunities.damage.join(', ') || 'æ— '
                                        }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">çŠ¶æ€å…ç–«</div>
                                    <div class="muted small">{{ uiState.monsterDraft.immunities.conditions.join(', ') ||
                                        'æ— ' }}</div>
                                </div>
                            </div>

                            <div class="hl"></div>

                            <div class="section-title">ç‰¹æ®Šèƒ½åŠ›/åŠ¨ä½œ</div>
                            <div class="grid" style="gap: 8px;">
                                <div class="card" v-for="a in sortedMonsterDraftActions" :key="a.id">
                                    <div class="row">
                                        <div class="title">{{ a.name }}</div>
                                        <div class="spacer"></div>
                                        <span class="tag">{{ a.type }}</span>
                                        <span class="tag" v-if="a.recharge > 0">å……èƒ½ {{ a.recharge }}</span>
                                    </div>
                                    <div class="muted small" style="margin-top: 6px;">
                                        <template v-if="a.type === 'attack'">
                                            <span>æ”»å‡»+{{ a.attackBonus }}</span>,
                                            <span v-if="a.range">è·ç¦»: {{ a.range }}</span>,
                                            <span>ä¼¤å®³: {{ formatDamages(a.damages) }}</span>
                                        </template>
                                        <template v-else-if="a.type === 'save'">
                                            <span v-if="a.range">è·ç¦»: {{ a.range }}</span>,
                                            <span>è±å…DC {{ a.saveDC }} {{ a.saveAbility?.toUpperCase() }}</span>,
                                            <span>ä¼¤å®³: {{ formatDamages(a.damages) }}</span>,
                                            <span v-if="a.onSuccess === 'half'">æˆåŠŸåˆ™åŠä¼¤</span>
                                        </template>
                                        <template v-else>
                                            <span>{{ a.note || 'å®ç”¨èƒ½åŠ›' }}</span>
                                        </template>
                                    </div>
                                </div>
                                <div v-if="!uiState.monsterDraft.actions?.length" class="placeholder small">æ— ç‰¹æ®Šèƒ½åŠ›æˆ–åŠ¨ä½œ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¼–è¾‘æ¨¡å¼ -->
                <div v-if="ui.monsterEditor.mode === 'edit'">
                    <div
                        style="display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <input type="file" ref="avatarUpload" @change="onAvatarImageSelect" accept="image/*" hidden>
                        <div class="avatar" style="width: 80px; height: 80px; font-size: 40px; cursor: pointer;"
                            @click="$refs.avatarUpload.click()">
                            <img v-if="uiState.monsterDraft.avatar" :src="uiState.monsterDraft.avatar" alt="Avatar"
                                style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                            <span v-else>ğŸ§Ÿ</span>
                        </div>
                        <button class="btn small" @click="$refs.avatarUpload.click()">ä¸Šä¼ /æ›´æ¢å¤´åƒ</button>
                    </div>
                    <div class="two-col">
                        <div class="col">
                            <label>åç§°</label>
                            <input class="input" v-model="uiState.monsterDraft.name" placeholder="ä¾‹å¦‚ï¼šå“¥å¸ƒæ—" />
                        </div>
                        <div class="col">
                            <label>CR</label>
                            <input type="number" step="0.5" class="input" v-model.number="uiState.monsterDraft.cr" />
                        </div>
                        <div class="col">
                            <label>ç±»å‹ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</label>
                            <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                <span v-for="typeKey in monsterTypes" :key="typeKey" class="chip"
                                    :class="{ active: uiState.monsterDraft.type.includes(typeKey) }"
                                    @click="toggleMonsterDraftType(typeKey)">
                                    {{ translateType(typeKey) }}
                                </span>
                            </div>
                        </div>
                        <div class="col">
                            <label>AC</label>
                            <input type="number" class="input" v-model.number="uiState.monsterDraft.ac" />
                        </div>
                        <div class="col">
                            <label>HP å¹³å‡</label>
                            <input type="number" class="input" v-model.number="uiState.monsterDraft.hp.average" />
                        </div>
                        <div class="col">
                            <label>é€Ÿåº¦ï¼ˆæ­¥è¡Œï¼‰</label>
                            <input type="number" class="input" v-model.number="uiState.monsterDraft.speed.walk" />
                        </div>
                    </div>

                    <details open>
                        <summary class="section-title">å…­å¤§å±æ€§</summary>
                        <div class="ability-grid" style="padding-top: 8px;">
                            <div class="ability" v-for="k in ['str','dex','con','int','wis','cha']" :key="k">
                                <div class="muted small">{{k.toUpperCase()}}</div>
                                <input type="number" class="input" style="width:80px"
                                    v-model.number="uiState.monsterDraft.abilities[k]" />
                            </div>
                        </div>
                    </details>

                    <div class="hl"></div>
                    <details>
                        <summary class="section-title">æŠ—æ€§/æ˜“ä¼¤/å…ç–«ï¼ˆä¼¤å®³/çŠ¶æ€ï¼‰</summary>
                        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px; padding-top: 8px;">
                            <div class="col">
                                <label>ä¼¤å®³æŠ—æ€§</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                                        :class="{active: uiState.monsterDraft.resistances.damage.includes(dt)}"
                                        @click="toggleDamageModifier('resistances', dt)">
                                        {{ dt }}
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <label>ä¼¤å®³æ˜“ä¼¤</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                                        :class="{active: uiState.monsterDraft.vulnerabilities.damage.includes(dt)}"
                                        @click="toggleDamageModifier('vulnerabilities', dt)">
                                        {{ dt }}
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <label>ä¼¤å®³å…ç–«</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                                        :class="{active: uiState.monsterDraft.immunities.damage.includes(dt)}"
                                        @click="toggleDamageModifier('immunities', dt)">
                                        {{ dt }}
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <label>çŠ¶æ€å…ç–«</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="ct in conditionTypes" :key="ct" class="chip"
                                        :class="{active: uiState.monsterDraft.immunities.conditions.includes(ct)}"
                                        @click="toggleConditionImmunity(ct)">
                                        {{ ct }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </details>

                    <div class="hl"></div>
                    <details open>
                        <summary class="section-title row">
                            <span>ç‰¹æ®Šèƒ½åŠ›/åŠ¨ä½œ</span>
                            <div class="spacer"></div>
                            <button class="btn small"
                                @click.prevent="openActionsViewer(uiState.monsterDraft, 'monster')">ç®¡ç†åŠ¨ä½œ</button>
                        </summary>
                    </details>

                    <div class="hl"></div>
                    <details>
                        <summary class="section-title">CR ä¸€é”®è°ƒæ•´</summary>
                        <div class="row" style="padding-top: 8px;">
                            <input type="number" step="0.5" class="input" style="width:120px"
                                v-model.number="uiState.targetCR" placeholder="ç›®æ ‡CR">
                            <button class="btn" @click="autoAdjustCR()">è°ƒæ•´</button>
                        </div>
                        <div class="danger-zone small" style="margin-top: 8px;">
                            TODOï¼šå®Œå–„â€œæ™ºèƒ½CRè°ƒæ•´ç®—æ³•â€æ˜ å°„è§„åˆ™ä¸èŒƒå›´å€¼éšæœºç”Ÿæˆã€æ ¹æ®ä¼¤å®³/è½®åç®—ä¼¤å®³éª°ã€‚ç›®å‰ä¸ºå ä½ç®€åŒ–å®ç°ï¼Œä¾¿äºåç»­æ›¿æ¢ã€‚
                        </div>
                    </details>
                </div>

                <div class="hl"></div>
                <div class="row">
                    <button class="btn ok" @click="updateMonster()" v-if="uiState.monsterDraft.id">æ›´æ”¹å¹¶å…³é—­</button>
                    <button class="btn ok" @click="saveMonsterAsNew()">å¦å­˜ä¸ºè‡ªå®šä¹‰</button>
                    <div class="spacer"></div>
                    <label class="row" style="cursor:pointer; margin-right: 16px;">
                        <input type="checkbox" v-model="uiState.monsterDraft.isDefault">
                        <span>è®¾ç½®ä¸ºé»˜è®¤å‚æˆ˜</span>
                    </label>
                    <button class="btn" @click="addToBattleFromEditor(uiState.monsterDraft, 'monster')">åŠ å…¥æˆ˜æ–—å¹¶å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šèƒ½åŠ›æ±  -->
        <div class="modal-mask" v-if="ui.abilityPool.open" :style="{ zIndex: ui.abilityPool.nested ? 60 : 50 }">
            <div class="modal">
                <div class="row">
                    <div class="title">ç‰¹æ®Šèƒ½åŠ›åº“</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.abilityPool.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="toolbar">
                    <input class="input" placeholder="æœç´¢èƒ½åŠ›..." v-model="ui.abilityPool.keyword" />
                    <button class="btn" @click="openAbilityEditor()">+ æ–°èƒ½åŠ›</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="ab in filteredAbilities" :key="ab.id">
                        <div class="row">
                            <div class="title">{{ab.name}}</div>
                            <div class="spacer"></div>
                            <button class="btn" @click="attachAbilityToDraft(ab)">æ·»åŠ åˆ°å½“å‰æ€ªç‰©</button>
                            <button class="btn" @click="openAbilityEditor(ab)">ç¼–è¾‘</button>
                            <button class="btn danger" @click="deleteAbility(ab.id)">åˆ é™¤</button>
                        </div>
                        <div class="muted small" style="margin-top:6px">{{ab.description}}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šåŠ¨ä½œåº“ -->
        <div class="modal-mask" v-if="ui.actionPool.open" :style="{ zIndex: ui.actionPool.nested ? 60 : 50 }">
            <div class="modal">
                <div class="row">
                    <div class="title">åŠ¨ä½œåº“</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.actionPool.open=false">è¿”å›ç§æœ‰åº“</button>
                    <button class="btn" @click="ui.actionPool.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="toolbar">
                    <input class="input" placeholder="æœç´¢åŠ¨ä½œ..." v-model="ui.actionPool.keyword" />
                    <button class="btn" @click="openActionEditor()">+ æ–°åŠ¨ä½œ</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="action in filteredActions" :key="action.id">
                        <div class="row">
                            <div class="title">{{action.name}}</div>
                            <span class="pill right">{{action.type}}</span>
                        </div>
                        <div class="kpi muted small" style="margin-top:6px">
                            <span class="pill" v-if="action.attackBonus">æ”»å‡»+{{action.attackBonus}}</span>
                            <span class="pill" v-if="action.damages?.length">{{ formatDamages(action.damages) }}</span>
                            <span class="pill" v-if="action.saveDC">è±å… DC{{action.saveDC}} {{action.saveAbility}}</span>
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="attachActionToDraft(action)">æ·»åŠ åˆ°å½“å‰ç”Ÿç‰©</button>
                            <button class="btn" @click="openActionEditor(action)">ç¼–è¾‘</button>
                            <button class="btn danger" @click="deleteAction(action.id)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šèƒ½åŠ›ç¼–è¾‘ -->
        <div class="modal-mask" v-if="ui.abilityEditor.open" :style="{ zIndex: ui.abilityEditor.nested ? 70 : 50 }">
            <div class="modal">
                <div class="row">
                    <div class="title">ç¼–è¾‘èƒ½åŠ›</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.abilityEditor.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="col">
                    <label>åç§°</label>
                    <input class="input" v-model="uiState.abilityDraft.name" />
                    <label>æè¿°</label>
                    <textarea class="input" rows="4" v-model="uiState.abilityDraft.description"
                        placeholder="èƒ½åŠ›è¯´æ˜..."></textarea>
                    <div class="hl"></div>
                    <button class="btn ok" @click="saveAbility()">ä¿å­˜å¹¶å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šPC ç¼–è¾‘ -->
        <div class="modal-mask" v-if="ui.pcEditor.open">
            <div class="modal">
                <div class="row">
                    <div class="title">PC è§’è‰²è¯¦æƒ…/ç¼–è¾‘å™¨</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.pcEditor.mode = ui.pcEditor.mode === 'view' ? 'edit' : 'view'">
                        {{ ui.pcEditor.mode === 'view' ? 'åˆ‡æ¢åˆ°ç¼–è¾‘æ¨¡å¼' : 'åˆ‡æ¢åˆ°æŸ¥çœ‹æ¨¡å¼' }}
                    </button>
                    <button class="btn" @click="ui.pcEditor.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>

                <!-- æŸ¥çœ‹æ¨¡å¼ -->
                <div v-if="ui.pcEditor.mode === 'view'">
                    <div class="monster-view-container" style="position: relative;">
                        <!-- èƒŒæ™¯å›¾ -->
                        <img v-if="uiState.pcDraft.backgroundImage" :src="uiState.pcDraft.backgroundImage"
                            style="position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.3; z-index: 1; border-radius: var(--radius);">

                        <!-- å†…å®¹å®¹å™¨ -->
                        <div style="position: relative; z-index: 2; padding: 12px;">
                            <div class="row">
                                <!-- ä¸Šä¼ æŒ‰é’® -->
                                <input type="file" ref="pcBgUpload" @change="onBgImageSelect" accept="image/*" hidden>
                                <button class="btn" @click="$refs.pcBgUpload.click()">ä¸Šä¼ èƒŒæ™¯</button>
                                <div class="avatar" style="width: 60px; height: 60px; font-size: 30px;">
                                    <img v-if="uiState.pcDraft.avatar" :src="uiState.pcDraft.avatar" alt="Avatar"
                                        style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                                    <span v-else>ğŸ§</span>
                                </div>
                                <div class="col">
                                    <h2 style="margin: 0;">{{ uiState.pcDraft.name }}</h2>
                                    <div class="kpi muted small" style="margin-top: 8px;">
                                        <span class="pill">AC {{uiState.pcDraft.ac}}</span>
                                        <span class="pill">HP {{uiState.pcDraft.hpCurrent}} / {{uiState.pcDraft.hpMax}}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="hl"></div>

                            <div class="section-title">å…­å¤§å±æ€§</div>
                            <div class="ability-grid">
                                <div class="ability" v-for="(v,k) in uiState.pcDraft.abilities" :key="k">
                                    <div class="muted small">{{k.toUpperCase()}}</div>
                                    <div style="font-weight:700">{{v}} ({{mod(v)>=0?'+':''}}{{mod(v)}})</div>
                                </div>
                            </div>

                            <div class="hl"></div>

                            <div class="three-col">
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³æŠ—æ€§</div>
                                    <div class="muted small">{{ (uiState.pcDraft.resistances.damage || []).join(', ') || 'æ— ' }}
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³æ˜“ä¼¤</div>
                                    <div class="muted small">{{ (uiState.pcDraft.vulnerabilities.damage || []).join(', ') || 'æ— '
                                        }}</div>
                                </div>
                                <div class="col">
                                    <div class="section-title">ä¼¤å®³å…ç–«</div>
                                    <div class="muted small">{{ (uiState.pcDraft.immunities.damage || []).join(', ') || 'æ— ' }}
                                    </div>
                                </div>
                                <div class="col">
                                    <div class="section-title">çŠ¶æ€å…ç–«</div>
                                    <div class="muted small">{{ (uiState.pcDraft.immunities.conditions || []).join(', ') || 'æ— '
                                        }}</div>
                                </div>
                            </div>

                            <div class="hl"></div>
                            <div class="section-title">ç‰¹æ€§</div>
                            <div class="muted small"
                                style="white-space: pre-wrap; background: #1a1d21; padding: 8px; border-radius: 8px;">{{
                                uiState.pcDraft.features || 'æ— ' }}</div>

                            <div class="hl"></div>

                            <div class="section-title">åŠ¨ä½œ</div>
                            <div class="grid" style="gap: 8px;">
                                <div class="card" v-for="a in sortedPcDraftActions" :key="a.id">
                                    <div class="row">
                                        <div class="title">{{ a.name }}</div>
                                        <div class="spacer"></div>
                                        <span class="tag">{{ a.type }}</span>
                                    </div>
                                    <div class="muted small" style="margin-top: 6px;">
                                        <template v-if="a.type === 'attack'">
                                            <span>æ”»å‡»+{{ a.attackBonus }}</span>,
                                            <span v-if="a.range">è·ç¦»: {{ a.range }}</span>,
                                            <span>ä¼¤å®³: {{ formatDamages(a.damages) }}</span>
                                        </template>
                                        <template v-else-if="a.type === 'save'">
                                            <span v-if="a.range">è·ç¦»: {{ a.range }}</span>,
                                            <span>è±å…DC {{ a.saveDC }} {{ a.saveAbility?.toUpperCase() }}</span>,
                                            <span>ä¼¤å®³: {{ formatDamages(a.damages) }}</span>
                                        </template>
                                        <template v-else>
                                            <span>{{ a.note || 'å®ç”¨èƒ½åŠ›' }}</span>
                                        </template>
                                    </div>
                                </div>
                                <div v-if="!uiState.pcDraft.actions?.length" class="placeholder small">æ— åŠ¨ä½œ</div>
                            </div>
                            <div class="hl"></div>
                            <div class="row">
                                <button class="btn ok" @click="savePC()">ä¿å­˜å¹¶å…³é—­</button>
                                <div class="spacer"></div>
                                <button class="btn" @click="addToBattleFromEditor(uiState.pcDraft, 'pc')">åŠ å…¥æˆ˜æ–—å¹¶å…³é—­</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¼–è¾‘æ¨¡å¼ -->
                <div v-if="ui.pcEditor.mode === 'edit'">
                    <div
                        style="display: flex; flex-direction: column; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <input type="file" ref="pcAvatarUpload" @change="onAvatarImageSelect" accept="image/*" hidden>
                        <div class="avatar" style="width: 80px; height: 80px; font-size: 40px; cursor: pointer;"
                            @click="$refs.pcAvatarUpload.click()">
                            <img v-if="uiState.pcDraft.avatar" :src="uiState.pcDraft.avatar" alt="Avatar"
                                style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                            <span v-else>ğŸ§</span>
                        </div>
                        <button class="btn small" @click="$refs.pcAvatarUpload.click()">ä¸Šä¼ /æ›´æ¢å¤´åƒ</button>
                    </div>
                    <div class="two-col">
                        <div class="col"><label>åç§°</label><input class="input" v-model="uiState.pcDraft.name" /></div>
                        <div class="col"><label>AC</label><input type="number" class="input"
                                v-model.number="uiState.pcDraft.ac" /></div>
                        <div class="col"><label>HP æœ€å¤§</label><input type="number" class="input"
                                v-model.number="uiState.pcDraft.hpMax" /></div>
                        <div class="col"><label>HP å½“å‰</label><input type="number" class="input"
                                v-model.number="uiState.pcDraft.hpCurrent" /></div>
                    </div>
                    <div class="section-title">å…­å¤§å±æ€§</div>
                    <div class="ability-grid">
                        <div class="ability" v-for="k in ['str','dex','con','int','wis','cha']" :key="k">
                            <div class="muted small">{{k.toUpperCase()}}</div>
                            <input type="number" class="input" style="width:80px"
                                v-model.number="uiState.pcDraft.abilities[k]" />
                        </div>
                    </div>

                    <details>
                        <summary class="section-title">æŠ—æ€§/æ˜“ä¼¤/å…ç–«ï¼ˆä¼¤å®³/çŠ¶æ€ï¼‰</summary>
                        <div class="grid" style="grid-template-columns: 1fr 1fr; gap: 12px; padding-top: 8px;">
                            <div class="col">
                                <label>ä¼¤å®³æŠ—æ€§</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                                        :class="{active: uiState.pcDraft.resistances.damage.includes(dt)}"
                                        @click="toggleDamageModifier('resistances', dt)">
                                        {{ dt }}
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <label>ä¼¤å®³æ˜“ä¼¤</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                                        :class="{active: uiState.pcDraft.vulnerabilities.damage.includes(dt)}"
                                        @click="toggleDamageModifier('vulnerabilities', dt)">
                                        {{ dt }}
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <label>ä¼¤å®³å…ç–«</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="dt in damageTypes" :key="dt" class="chip"
                                        :class="{active: uiState.pcDraft.immunities.damage.includes(dt)}"
                                        @click="toggleDamageModifier('immunities', dt)">
                                        {{ dt }}
                                    </span>
                                </div>
                            </div>
                            <div class="col">
                                <label>çŠ¶æ€å…ç–«</label>
                                <div class="row" style="flex-wrap: wrap; gap: 6px;">
                                    <span v-for="ct in conditionTypes" :key="ct" class="chip"
                                        :class="{active: uiState.pcDraft.immunities.conditions.includes(ct)}"
                                        @click="toggleConditionImmunity(ct)">
                                        {{ ct }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </details>

                    <div class="section-title row">
                        <span>ç‰¹æ€§</span>
                    </div>
                    <textarea class="input underline-input" rows="3" v-model="uiState.pcDraft.features"
                        placeholder="è¾“å…¥è§’è‰²çš„ç‰¹æ€§ã€èƒŒæ™¯ã€å…³é”®ä¿¡æ¯ç­‰..."></textarea>

                    <div class="section-title row">
                        <span>åŠ¨ä½œ</span>
                        <div class="spacer"></div>
                        <button class="btn small"
                            @click.prevent="openActionsViewer(uiState.pcDraft, 'pc')">ç®¡ç†åŠ¨ä½œ</button>
                    </div>

                    <div class="hl"></div>
                    <div class="row">
                        <button class="btn ok" @click="savePC()">ä¿å­˜å¹¶å…³é—­</button>
                        <div class="spacer"></div>
                        <label class="row" style="cursor:pointer; margin-right: 16px;">
                            <input type="checkbox" v-model="uiState.pcDraft.isDefault">
                            <span>è®¾ç½®ä¸ºé»˜è®¤å‚æˆ˜</span>
                        </label>
                        <button class="btn" @click="addToBattleFromEditor(uiState.pcDraft, 'pc')">åŠ å…¥æˆ˜æ–—å¹¶å…³é—­</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šåŠ¨ä½œç¼–è¾‘ -->
        <div class="modal-mask" v-if="ui.actionEditor.open" :style="{ zIndex: ui.actionEditor.nested ? 65 : 50 }">
            <div class="modal">
                <div class="row">
                    <div class="title">ç¼–è¾‘åŠ¨ä½œ</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.actionEditor.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="col">
                    <div class="row">
                        <div class="col">
                            <label>åŠ¨ä½œåç§°</label>
                            <input class="input" style="min-width:160px" v-model="uiState.actionDraft.name"
                                placeholder="åŠ¨ä½œåç§°" />
                        </div>
                        <div class="col">
                            <label>ç±»å‹</label>
                            <select class="input" v-model="uiState.actionDraft.type">
                                <option value="attack">æ”»å‡»æ£€å®š</option>
                                <option value="save">è±å…æ£€å®š</option>
                                <option value="utility">å…¶ä»–</option>
                            </select>
                        </div>
                    </div>
                    <div class="hl"></div>
                    <div class="row small" style="gap:12px">
                        <template v-if="uiState.actionDraft.type==='attack'">
                            <div class="col">
                                <label>æ”»å‡»åŠ å€¼</label>
                                <input type="number" class="input" style="width:90px"
                                    v-model.number="uiState.actionDraft.attackBonus" />
                            </div>
                            <div class="col">
                                <label>æ”»å‡»è·ç¦»</label>
                                <input class="input" style="width:90px" v-model="uiState.actionDraft.range"
                                    placeholder="ä¾‹å¦‚ 5 ft." />
                            </div>
                            <div class="col" style="grid-column: span 2;">
                                <div class="row">
                                    <label>å¤šæ®µä¼¤å®³</label>
                                    <div class="spacer"></div>
                                    <button class="btn small" @click="addDamageToActionDraft()">+ æ·»åŠ ä¼¤å®³</button>
                                </div>
                                <div v-for="(damage, index) in uiState.actionDraft.damages" :key="damage.id" class="row"
                                    style="margin-top: 4px;">
                                    <input class="input mono" style="width:120px" v-model="damage.dice"
                                        placeholder="ä¾‹å¦‚ 2d6+3" />
                                    <select class="input" v-model="damage.type">
                                        <option v-for="dt in damageTypes" :key="dt" :value="dt">{{dt}}</option>
                                    </select>
                                    <button v-if="index > 0" class="btn danger small"
                                        @click="confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ®µä¼¤å®³å—ï¼Ÿ') && uiState.actionDraft.damages.splice(index, 1)">åˆ é™¤</button>
                                </div>
                            </div>
                            <div class="col">
                                <label>å……èƒ½å›åˆ</label>
                                <input type="number" class="input" style="width:90px"
                                    v-model.number="uiState.actionDraft.recharge" placeholder="0" />
                            </div>
                            <div class="col">
                                <label>å‘½ä¸­é™„åŠ çŠ¶æ€</label>
                                <select class="input" v-model="uiState.actionDraft.onHitStatus">
                                    <option value="">æ— </option>
                                    <option v-for="s in statusCatalog" :key="s.name" :value="s.name">{{s.name}}</option>
                                </select>
                                <div v-if="uiState.actionDraft.onHitStatus" class="form-row">
                                    <label>
                                        è±å…å±æ€§:
                                        <select v-model="uiState.actionDraft.onHitSaveAbility">
                                            <option value="str">åŠ›é‡ (Strength)</option>
                                            <option value="dex">æ•æ· (Dexterity)</option>
                                            <option value="con">ä½“è´¨ (Constitution)</option>
                                            <option value="int">æ™ºåŠ› (Intelligence)</option>
                                            <option value="wis">æ„ŸçŸ¥ (Wisdom)</option>
                                            <option value="cha">é­…åŠ› (Charisma)</option>
                                        </select>
                                    </label>
                                    <label>
                                        è±å…DC:
                                        <input type="number" v-model.number="uiState.actionDraft.onHitSaveDC"
                                            style="width: 60px;">
                                    </label>
                                </div>
                            </div>
                            <div class="col" v-if="uiState.actionDraft.onHitStatus">
                                <label>çŠ¶æ€æŒç»­å›åˆ</label>
                                <input type="number" class="input" style="width:90px"
                                    v-model.number="uiState.actionDraft.onHitStatusRounds" placeholder="é»˜è®¤1" />
                            </div>
                        </template>
                        <template v-else-if="uiState.actionDraft.type==='save'">
                            <div class="col">
                                <label>è±å…å±æ€§</label>
                                <select class="input" v-model="uiState.actionDraft.saveAbility">
                                    <option>str</option>
                                    <option>dex</option>
                                    <option>con</option>
                                    <option>int</option>
                                    <option>wis</option>
                                    <option>cha</option>
                                </select>
                            </div>
                            <div class="col">
                                <label>DC</label>
                                <input type="number" class="input" style="width:90px"
                                    v-model.number="uiState.actionDraft.saveDC" />
                            </div>
                            <div class="col">
                                <label>æ”»å‡»è·ç¦»</label>
                                <input class="input" style="width:90px" v-model="uiState.actionDraft.range"
                                    placeholder="ä¾‹å¦‚ 30 ft." />
                            </div>
                            <div class="col" style="grid-column: span 2;">
                                <div class="row">
                                    <label>å¤šæ®µä¼¤å®³</label>
                                    <div class="spacer"></div>
                                    <button class="btn small" @click="addDamageToActionDraft()">+ æ·»åŠ ä¼¤å®³</button>
                                </div>
                                <div v-for="(damage, index) in uiState.actionDraft.damages" :key="damage.id" class="row"
                                    style="margin-top: 4px;">
                                    <input class="input mono" style="width:120px" v-model="damage.dice"
                                        placeholder="ä¾‹å¦‚ 2d6+3" />
                                    <select class="input" v-model="damage.type">
                                        <option v-for="dt in damageTypes" :key="dt" :value="dt">{{dt}}</option>
                                    </select>
                                    <button v-if="index > 0" class="btn danger small"
                                        @click="confirm('ç¡®å®šè¦åˆ é™¤æ­¤æ®µä¼¤å®³å—ï¼Ÿ') && uiState.actionDraft.damages.splice(index, 1)">åˆ é™¤</button>
                                </div>
                            </div>
                            <div class="col">
                                <label>å……èƒ½å›åˆ</label>
                                <input type="number" class="input" style="width:90px"
                                    v-model.number="uiState.actionDraft.recharge" placeholder="0" />
                            </div>
                            <div class="col">
                                <label>æˆåŠŸæ˜¯å¦åŠä¼¤</label>
                                <select class="input" v-model="uiState.actionDraft.onSuccess">
                                    <option value="half">åŠä¼¤</option>
                                    <option value="none">å…ç–«</option>
                                </select>
                            </div>
                        </template>
                        <template v-else>
                            <span class="muted">å®ç”¨åŠ¨ä½œï¼Œæ— è‡ªåŠ¨ç»“ç®—</span>
                        </template>
                    </div>
                    <div class="hl"></div>
                    <button class="btn ok" @click="saveAction()">ä¿å­˜å¹¶å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šçŠ¶æ€é€‰æ‹©å™¨ -->
        <div class="modal-mask" v-if="ui.statusPicker.open">
            <div class="modal">
                <div class="row">
                    <div class="title">æ–½åŠ çŠ¶æ€</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.statusPicker.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <select class="input" v-model="ui.statusPicker.selectedName">
                        <option v-for="s in statusCatalog" :key="s.name" :value="s.name">{{s.name}}</option>
                    </select>
                    <input type="number" class="input" style="width:120px" v-model.number="ui.statusPicker.rounds"
                        placeholder="æŒç»­å›åˆæ•°">
                    <input class="input" style="width:120px" v-model="ui.statusPicker.icon" placeholder="å›¾æ ‡(emoji å¯)">
                    <button class="btn ok" @click="applyStatus()">åº”ç”¨</button>
                </div>
                <div class="ok-zone small" style="margin-top:8px">
                    å·²æ”¯æŒè‡ªåŠ¨è¿½è¸ªçŠ¶æ€æ—¶é•¿ï¼Œæ¯åˆ°å›åˆå¼€å§‹è‡ªåŠ¨ -1ï¼Œè‡³ 0 è‡ªåŠ¨ç§»é™¤ã€‚ä¹Ÿå¯æ‰‹åŠ¨ç§»é™¤æˆ–è°ƒæ•´ã€‚
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šå›¾ç‰‡è£å‰ª -->
        <div class="modal-mask" v-if="ui.imageCropper.open" style="z-index: 60;">
            <div class="modal" ref="cropperModal">
                <div class="title">è£å‰ªå›¾ç‰‡</div>
                <div class="hl"></div>
                <div style="max-height: 60vh; overflow: auto; text-align: center; position: relative;">
                    <canvas ref="cropperCanvas" @mousedown="startBgDrag" @mousemove="bgDrag" @mouseup="endBgDrag"
                        @mouseleave="endBgDrag"></canvas>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <button class="btn ok" @click="confirmCrop()">ç¡®è®¤è£å‰ª</button>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.imageCropper.open = false">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šå¤´åƒè£å‰ª -->
        <div class="modal-mask" v-if="ui.avatarCropper.open" style="z-index: 60;">
            <div class="modal" ref="avatarCropperModal">
                <div class="title">è£å‰ªå¤´åƒ</div>
                <div class="hl"></div>
                <div style="max-height: 60vh; overflow: auto; text-align: center; position: relative;">
                    <canvas ref="avatarCropperCanvas" @mousedown="startAvatarDrag" @mousemove="avatarDrag" @mouseup="endAvatarDrag"
                        @mouseleave="endAvatarDrag"></canvas>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <button class="btn ok" @click="confirmAvatarCrop()">ç¡®è®¤è£å‰ª</button>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.avatarCropper.open = false">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šHP ç¼–è¾‘ -->
        <div class="modal-mask" v-if="ui.hpEditor.open">
            <div class="modal">
                <div class="row">
                    <div class="title">ç¼–è¾‘HP</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.hpEditor.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <input class="input mono" style="width:120px" v-model.number="ui.hpEditor.delta"
                        placeholder="+/-HP">
                    <button class="btn"
                        @click="applyHPDelta(battle.participants.find(p=>p.uid===ui.hpEditor.targetUid), ui.hpEditor.delta); ui.hpEditor.open=false">åº”ç”¨</button>
                    <button class="btn"
                        @click="applyHPDelta(battle.participants.find(p=>p.uid===ui.hpEditor.targetUid), Math.floor((ui.hpEditor.delta||0)/2)); ui.hpEditor.open=false">åŠä¼¤</button>
                    <button class="btn"
                        @click="applyHPDelta(battle.participants.find(p=>p.uid===ui.hpEditor.targetUid), (ui.hpEditor.delta||0)*2); ui.hpEditor.open=false">åŒå€</button>
                    <button class="btn ok"
                        @click="applyHPDelta(battle.participants.find(p=>p.uid===ui.hpEditor.targetUid), Math.abs(ui.hpEditor.delta||0)); ui.hpEditor.open=false">æ²»ç–—</button>
                    
                    <div style="width: 1px; background: #eee; height: 32px; margin: 0 8px;"></div>
                    <input class="input mono" style="width:100px" v-model.number="ui.hpEditor.tempHpInput" placeholder="è™šå‡ç”Ÿå‘½">
                    <button class="btn"
                        @click="setTempHp(battle.participants.find(p=>p.uid===ui.hpEditor.targetUid), ui.hpEditor.tempHpInput); ui.hpEditor.open=false">åˆ·æ–°</button>
                </div>
            </div>
        </div>
        <!-- æ¨¡æ€ï¼šå¿«é€Ÿæ‰£è¡€ï¼ˆåŠŸèƒ½ä¿®å¤ç‰ˆï¼‰ -->
        <div class="modal-mask" v-if="ui.quickDamage.open">
            <div class="modal" style="max-width: 400px;">
                <form @submit.prevent="applyQuickDamage">
                    <div class="row">
                        <div class="title">å¿«é€Ÿæ‰£è¡€: {{ ui.quickDamage.targetName }}</div>
                        <div class="spacer"></div>
                        <button class="btn" type="button" @click="closeQuickDamageEditor">å…³é—­</button>
                    </div>
                    <div class="hl"></div>
                    <div class="col">
                        <label>è¾“å…¥è¦æ‰£é™¤çš„ç”Ÿå‘½å€¼ï¼ˆä»…æ•°å­—ï¼‰</label>
                        <input ref="quickDamageInput" class="input mono" style="margin-top: 8px;" type="number"
                            v-model.number="ui.quickDamage.damageAmount" placeholder="ä¾‹å¦‚: 15">
                    </div>
                    <div class="hl"></div>
                    <div class="row">
                        <div class="spacer"></div>
                        <button class="btn primary" type="submit">ç¡®è®¤æ‰£è¡€</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šæ€ªç‰©ç»„åˆç®¡ç†å™¨ -->
        <div class="modal-mask" v-if="ui.monsterGroupManager.open">
            <div class="modal">
                <div class="row">
                    <div class="title">æ€ªç‰©ç»„åˆç®¡ç†</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.monsterGroupManager.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="toolbar">
                    <button class="btn primary" @click="openGroupEditor()">+ æ–°å»ºç»„</button>
                </div>
                <div class="grid cards">
                    <div class="card" v-for="group in monsterGroups" :key="group.id">
                        <div class="title">{{ group.name }}</div>
                        <div class="muted small" style="margin-top: 6px;">
                            åŒ…å« {{ group.monsters.reduce((acc, m) => acc + m.count, 0) }} ä¸ªæ€ªç‰©
                        </div>
                        <div class="hl"></div>
                        <div class="row">
                            <button class="btn" @click="openGroupEditor(group)">è®¾ç½®</button>
                            <div class="spacer"></div>
                            <button class="btn danger" @click="deleteGroup(group.id)">åˆ é™¤ç»„</button>
                        </div>
                    </div>
                    <div v-if="!monsterGroups.length" class="placeholder">æš‚æ— ç»„åˆï¼Œè¯·æ–°å»ºã€‚</div>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šæ€ªç‰©ç»„åˆç¼–è¾‘å™¨ -->
        <div class="modal-mask" v-if="ui.monsterGroupEditor.open" style="z-index: 55;">
            <div class="modal" style="max-width: 960px;">
                <div class="row">
                    <div class="title">{{ uiState.groupDraft.id ? 'ç¼–è¾‘' : 'æ–°å»º' }}æ€ªç‰©ç»„åˆ</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.monsterGroupEditor.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="col" style="margin-bottom: 12px;">
                    <label>ç»„åˆåç§°</label>
                    <input class="input" v-model="uiState.groupDraft.name" placeholder="ä¾‹å¦‚ï¼šå“¥å¸ƒæ—å·¡é€»é˜Ÿ" />
                </div>
                <div class="two-col">
                    <!-- å·¦ä¾§ï¼šé€‰æ‹©æ€ªç‰© -->
                    <div class="pane" style="max-height: 50vh; overflow: auto; background: var(--bg);">
                        <div class="sticky-toolbar" style="top: -12px; padding: 8px; margin: -12px -12px 8px -12px;">
                            <input class="input" v-model="ui.monsterGroupEditor.keyword" placeholder="æœç´¢æ€ªç‰©..."
                                style="width: 100%;" />
                        </div>
                        <div class="grid" style="gap: 8px;">
                            <div class="row" v-for="m in filteredMonstersForGroup" :key="m.id">
                                <span>{{m.name}} <span class="muted small">CR {{m.cr}}</span></span>
                                <div class="spacer"></div>
                                <button class="btn small" @click="addMonsterToGroupDraft(m)">+ æ·»åŠ </button>
                            </div>
                        </div>
                    </div>
                    <!-- å³ä¾§ï¼šå·²é€‰æ€ªç‰© -->
                    <div class="pane" style="max-height: 50vh; overflow: auto; background: var(--bg);">
                        <div class="section-title">ç»„å†…æ€ªç‰©</div>
                        <div class="grid" style="gap: 8px;">
                            <div class="row" v-for="(gm, index) in uiState.groupDraft.monsters"
                                :key="gm.monsterId + '-' + index">
                                <span>{{ gm.name }}</span>
                                <div class="spacer"></div>
                                <input type="number" class="input small" style="width: 80px" v-model.number="gm.count"
                                    min="1">
                                <button class="btn danger small"
                                    @click="uiState.groupDraft.monsters.splice(index, 1)">ç§»é™¤</button>
                            </div>
                            <div v-if="!uiState.groupDraft.monsters.length" class="placeholder small">è¯·ä»å·¦ä¾§æ·»åŠ æ€ªç‰©</div>
                        </div>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <button class="btn ok" @click="saveGroup()">å®Œæˆå¹¶ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šæ·»åŠ å‚æˆ˜å•ä½ -->
        <div class="modal-mask" v-if="ui.addParticipants.open">
            <div class="modal" style="max-width: 1024px;">
                <div class="row">
                    <div class="title">æ·»åŠ å‚æˆ˜å•ä½</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.addParticipants.open=false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div class="three-col">
                    <div>
                        <div class="section-title">ä»æ€ªç‰©åº“æ·»åŠ </div>
                        <input class="input" placeholder="æœç´¢æ€ªç‰©..." v-model="ui.addParticipants.keywordM" />
                        <div class="grid" style="margin-top:8px;max-height:260px;overflow:auto">
                            <div class="row"
                                v-for="m in monsters.filter(x=>!ui.addParticipants.keywordM || x.name.includes(ui.addParticipants.keywordM))"
                                :key="m.id">
                                <span>{{m.name}} <span class="muted small">CR {{m.cr}}</span></span>
                                <div class="spacer"></div>
                                <input type="number" class="input small" style="width:90px" v-model.number="m._addCount"
                                    placeholder="æ•°é‡">
                                <button class="btn small"
                                    @click="addParticipantsFromMonster(m, m._addCount||1)">æ·»åŠ </button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <div class="section-title">ä»PCåº“æ·»åŠ </div>
                        <input class="input" placeholder="æœç´¢PC..." v-model="ui.addParticipants.keywordP" />
                        <div class="grid" style="margin-top:8px;max-height:260px;overflow:auto">
                            <div class="row"
                                v-for="pc in pcs.filter(x=>!ui.addParticipants.keywordP || x.name.includes(ui.addParticipants.keywordP))"
                                :key="pc.id">
                                <span>{{pc.name}}</span>
                                <div class="spacer"></div>
                                <button class="btn small" @click="addParticipantsFromPC(pc)">æ·»åŠ </button>
                            </div>
                        </div>
                    </div>
                    <!-- è¿™æ˜¯ç¬¬ä¸‰åˆ—ï¼Œç”¨äºç»„åˆå‡ºæˆ˜ -->
                    <div>
                        <div class="section-title">ä»ç»„åˆå‡ºæˆ˜</div>
                        <div class="grid" style="margin-top:8px;max-height:260px;overflow:auto">
                            <div class="row" v-for="group in monsterGroups" :key="group.id">
                                <span>{{group.name}}</span>
                                <div class="spacer"></div>
                                <button class="btn small" @click="addParticipantsFromGroup(group)">æ·»åŠ </button>
                            </div>
                            <div v-if="!monsterGroups.length" class="placeholder small">å°šæœªè®¾ç½®ä»»ä½•ç»„åˆ</div>
                        </div>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="ok-zone small">æç¤ºï¼šåŒåæ€ªç‰©ä¼šè‡ªåŠ¨åˆ†ç»„ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨å•ä½ä¸Šæ‰‹åŠ¨è®¾å®š groupNameã€‚</div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šè±å…æ£€å®š -->
        <div v-if="ui.saveCheck.open" class="modal-mask">
            <div class="modal-wrapper">
                <div class="modal-container">
                    <div class="modal-header">
                        <h3>è±å…æ£€å®š</h3>
                    </div>
                    <div class="modal-body">
                        <p>ç›®æ ‡ <strong>{{ ui.saveCheck.targetName }}</strong> éœ€è¦è¿›è¡Œä¸€æ¬¡ <strong>DC {{ ui.saveCheck.dc
                                }}</strong> çš„ <strong>{{ ui.saveCheck.ability.toUpperCase() }}</strong> è±å…æ£€å®šã€‚</p>
                        <p>è¯·æŠ•æ·d20å¹¶åŠ ä¸Šç›®æ ‡çš„è±å…è°ƒæ•´å€¼ã€‚</p>
                    </div>
                    <div class="modal-footer">
                        <button class="modal-default-button" @click="ui.saveCheck.callback(true)">
                            è±å…æˆåŠŸ
                        </button>
                        <button class="modal-default-button" @click="ui.saveCheck.callback(false)">
                            è±å…å¤±è´¥
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šè±å…ç»“æœé€‰æ‹©å™¨ -->
        <div class="modal-mask" v-if="ui.saveOutcomePicker.open">
            <div class="modal">
                <div class="row">
                    <div class="title">{{ ui.saveOutcomePicker.title }}</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.saveOutcomePicker.open=false">å–æ¶ˆ</button>
                </div>
                <div class="hl"></div>
                <div class="col" style="gap: 12px; max-height: 60vh; overflow-y: auto; padding: 4px;">
                    <p class="muted small">è¯·ä¸ºæ¯ä¸ªç›®æ ‡é€‰æ‹©è±å…æ£€å®šçš„ç»“æœã€‚æ€»æ½œåœ¨ä¼¤å®³: **{{ formatRolledDamages(ui.saveOutcomePicker.damages)
                        }}**</p>
                    <div v-for="target in ui.saveOutcomePicker.targets" :key="target.uid" class="card">
                        <div class="row">
                            <div class="avatar">
                                <img v-if="target.avatar" :src="target.avatar" :alt="target.name">
                                <span v-else>ğŸ¯</span>
                            </div>
                            <strong style="margin-left: 8px;">{{ target.name }}</strong>
                            <div class="spacer"></div>
                            <div class="row">
                                <label class="chip"
                                    :class="{active: ui.saveOutcomePicker.outcomes[target.uid] === 'fail'}">
                                    <input type="radio" :name="'outcome-' + target.uid" value="fail"
                                        v-model="ui.saveOutcomePicker.outcomes[target.uid]"> è±å…å¤±è´¥
                                </label>
                                <label class="chip"
                                    :class="{active: ui.saveOutcomePicker.outcomes[target.uid] === 'half'}">
                                    <input type="radio" :name="'outcome-' + target.uid" value="half"
                                        v-model="ui.saveOutcomePicker.outcomes[target.uid]"> ä¼¤å®³å‡åŠ
                                </label>
                                <label class="chip"
                                    :class="{active: ui.saveOutcomePicker.outcomes[target.uid] === 'zero'}">
                                    <input type="radio" :name="'outcome-' + target.uid" value="zero"
                                        v-model="ui.saveOutcomePicker.outcomes[target.uid]"> ä¼¤å®³å…¨å…
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <div class="spacer"></div>
                    <button class="btn ok" @click="applySaveOutcomes()">ç¡®è®¤å¹¶åº”ç”¨ç»“æœ</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šåŠ¨ä½œç®¡ç† -->
        <div class="modal-mask" v-if="ui.actionsViewer.open" style="z-index: 55;">
            <div class="modal">
                <div class="row">
                    <div class="title">ç®¡ç†åŠ¨ä½œ (ç§æœ‰åº“)</div>
                    <div class="spacer"></div>
                </div>
                <div class="hl"></div>
                <div class="pane" style="max-height: 60vh; overflow-y: auto; background: var(--bg); padding: 8px;">
                    <div class="grid cards">
                        <div class="card" v-for="(a, idx) in ui.actionsViewer.draft.actions" :key="a.id">
                            <div class="row">
                                <div class="title">{{a.name}}</div>
                                <span class="pill right">{{a.type}}</span>
                                <div class="spacer"></div>
                                <button class="btn" @click="openActionEditorForDraft(a)">ç¼–è¾‘</button>
                                <button class="btn danger"
                                    @click="ui.actionsViewer.draft.actions.splice(idx,1)">åˆ é™¤</button>
                            </div>
                            <div class="kpi muted small" style="margin-top:6px">
                                <span class="pill" v-if="a.attackBonus">æ”»å‡»+{{a.attackBonus}}</span>
                                <span class="pill" v-if="a.range">è·ç¦»: {{a.range}}</span>
                                <span class="pill" v-if="a.damages?.length">{{ formatDamages(a.damages) }}</span>
                                <span class="pill" v-if="a.range">è·ç¦»: {{a.range}}</span>
                                <span class="pill" v-if="a.saveDC">è±å… DC{{a.saveDC}} {{a.saveAbility}}</span>
                            </div>
                        </div>
                        <div v-if="!ui.actionsViewer.draft.actions?.length" class="placeholder small">æš‚æ— åŠ¨ä½œ</div>
                    </div>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <button class="btn primary" @click="openActionEditorForDraft()">+ æ–°å»ºç§æœ‰åŠ¨ä½œ</button>
                    <button class="btn" @click="openActionPool()">ä»åŠ¨ä½œåº“æ·»åŠ </button>
                    <button class="btn" @click="openAbilityPool()">ä»èƒ½åŠ›æ± æ·»åŠ </button>
                    <div class="spacer"></div>
                    <button class="btn ok" @click="ui.actionsViewer.open = false">å®Œæˆå¹¶å…³é—­</button>
                </div>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šå¤§æˆåŠŸ/å¤§å¤±è´¥æç¤º -->
        <div v-if="ui.critNotification.open" class="crit-notification-mask">
            <div class="crit-notification-modal" :class="ui.critNotification.type">
                <div class="hit-info-header" style="border-bottom: none; padding-bottom: 0;">
                    <span>{{ ui.critNotification.attacker }} âš”ï¸ {{ ui.critNotification.target }}</span>
                    <span class="hit-roll-display">
                        å‘½ä¸­æ£€å®š: {{ ui.critNotification.toHitRoll }} =
                        <span class="hit-result">{{ ui.critNotification.toHitResult }}</span> vs AC {{
                        ui.critNotification.targetAC }}
                    </span>
                </div>

                <div class="crit-text">{{ ui.critNotification.type === 'success' ? 'å¤§æˆåŠŸ' : 'å¤§å¤±è´¥' }}</div>

                <template v-if="ui.critNotification.type === 'success'">
                    <div class="damage-details" style="font-size: 1.2em; margin-top: 12px;">
                        <span>
                            <template v-for="(detail, index) in ui.critNotification.damages">
                                {{ detail.finalAmount }}
                                <span class="muted small">
                                    ({{ detail.type }}<span v-if="detail.modifier"> {{ detail.modifier }}</span>)
                                </span>
                                <span v-if="index < ui.critNotification.damages.length - 1"> + </span>
                            </template>
                        </span>
                    </div>
                    <div class="final-damage-section">
                        <div class="final-damage-value">
                            {{ ui.critNotification.totalFinalDamage }}
                        </div>
                        <div class="final-damage-label">
                            æœ€ç»ˆæ€»ä¼¤å®³
                        </div>
                    </div>
                </template>

                <button class="btn" @click="dismissCurrentNotification" style="margin-top: 20px;">å…³é—­</button>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šæ™®é€šå‘½ä¸­è¯¦æƒ…æç¤º -->
        <div v-if="ui.normalHitNotification.open" class="crit-notification-mask">
            <div class="normal-hit-notification-modal">
                <div class="hit-info-header">
                    <span>{{ ui.normalHitNotification.attacker }} âš”ï¸ {{ ui.normalHitNotification.target }}</span>
                    <span class="hit-roll-display">
                        å‘½ä¸­æ£€å®š: {{ ui.normalHitNotification.toHitRoll }} =
                        <span class="hit-result">{{ ui.normalHitNotification.toHitResult }}</span> vs AC {{
                        ui.normalHitNotification.targetAC }}
                    </span>
                </div>
                <div class="damage-details" style="font-size: 1.2em; margin-top: 12px;">
                    <span>
                        <template v-for="(detail, index) in ui.normalHitNotification.damages">
                            {{ detail.finalAmount }}
                            <span class="muted small">
                                ({{ detail.type }}<span v-if="detail.modifier"> {{ detail.modifier }}</span>)
                            </span>
                            <span v-if="index < ui.normalHitNotification.damages.length - 1"> + </span>
                        </template>
                    </span>
                </div>
                <div class="final-damage-section">
                    <div class="final-damage-value">
                        {{ ui.normalHitNotification.totalFinalDamage }}
                    </div>
                    <div class="final-damage-label">
                        æœ€ç»ˆæ€»ä¼¤å®³
                    </div>
                </div>
                <button class="btn" @click="dismissCurrentNotification" style="margin-top: 16px;">å…³é—­</button>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šå¿«æ·æŠ•éª°è¾“å…¥ -->
        <div v-if="ui.quickDice.inputOpen" class="modal-mask" @click.self="ui.quickDice.inputOpen = false">
            <div class="modal" style="max-width: 480px;">
                <form @submit.prevent="executeQuickRoll">
                    <div class="row">
                        <div class="title">å¿«æ·æŠ•éª°</div>
                        <div class="spacer"></div>
                        <button class="btn" type="button" @click="ui.quickDice.inputOpen = false">å…³é—­</button>
                    </div>
                    <div class="hl"></div>
                    <div class="col">
                        <label>è¾“å…¥æŠ•éª°è¡¨è¾¾å¼ (ä¾‹å¦‚: 1d20+1d4+2)</label>
                        <input ref="quickRollInput" class="input mono" style="margin-top: 8px; font-size: 1.2em;"
                            type="text" v-model="ui.quickDice.expression" placeholder="e.g. 2d8+4">
                    </div>
                    <div class="hl"></div>
                    <div class="row">
                        <div class="spacer"></div>
                        <button class="btn primary" type="submit">æŠ•éª° (Enter)</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- æ¨¡æ€ï¼šå¿«æ·æŠ•éª°ç»“æœ -->
        <div v-if="ui.quickDice.resultOpen" class="modal-mask" @click.self="ui.quickDice.resultOpen = false">
            <div class="modal dice-result-modal" style="max-width: 520px; text-align: center;">
                <div class="row">
                    <div class="title">æŠ•éª°ç»“æœ: {{ ui.quickDice.expression }}</div>
                    <div class="spacer"></div>
                    <button class="btn" @click="ui.quickDice.resultOpen = false">å…³é—­</button>
                </div>
                <div class="hl"></div>
                <div v-if="ui.quickDice.result">
                    <div class="dice-result-breakdown">
                        <template v-for="(group, groupIndex) in ui.quickDice.result.rolls">
                            <span v-for="(roll, rollIndex) in group.results" :key="group.die + rollIndex">
                                {{ group.die }}: <strong>{{ roll }}</strong>
                                <br>
                            </span>
                        </template>
                        <span v-if="ui.quickDice.result.modifier !== 0">
                            è°ƒæ•´å€¼: <strong>{{ ui.quickDice.result.modifier > 0 ? '+' : '' }}{{
                                ui.quickDice.result.modifier }}</strong>
                        </span>
                    </div>
                    <div class="dice-result-total-label">æ€»è®¡</div>
                    <div class="dice-result-total">{{ ui.quickDice.result.total }}</div>
                </div>
                <div class="hl"></div>
                <div class="row">
                    <div class="spacer"></div>
                    <button class="btn ok" @click="ui.quickDice.resultOpen = false">å¥½çš„</button>
                </div>
            </div>
        </div>
        <!-- æ¨¡æ€ï¼šæœªå‘½ä¸­æç¤º -->
        <div v-if="ui.missNotification.open" class="crit-notification-mask">
            <div class="miss-notification-modal">
                <div class="hit-info-header">
                    <span>{{ ui.missNotification.attacker }} âš”ï¸ {{ ui.missNotification.target }}</span>
                    <span class="hit-roll-display">
                        å‘½ä¸­æ£€å®š: {{ ui.missNotification.toHitRoll }} =
                        <span class="hit-result">{{ ui.missNotification.toHitResult }}</span> vs AC {{
                        ui.missNotification.targetAC }}
                    </span>
                </div>
                <div class="miss-text-section">
                    <div class="miss-text">æœªå‘½ä¸­</div>
                </div>
                <button class="btn" @click="dismissCurrentNotification" style="margin-top: 16px;">å…³é—­</button>
            </div>
        </div>

        <!-- Toast æç¤ºå®¹å™¨ -->
        <transition-group name="toast-fade" tag="div" class="toast-container">
            <div v-for="toast in ui.toasts" :key="toast.id" class="toast-item">
                <span class="toast-message">{{ toast.message }}</span>
                <button class="toast-close" @click="removeToast(toast.id)">&times;</button>
            </div>
        </transition-group>
    </div>

    <script type="importmap">
{
  "imports": {
    "vue": "./js/vendor/vue.js",
    "dexie": "./js/vendor/dexie.js",

    "utils": "./js/modules/shared/utils.js",
    "helpers": "./js/modules/shared/helpers.js",

    "state": "./js/modules/state/state.js",
    "constants": "./js/modules/state/constants.js",

    "db": "./js/modules/infra/persistence/db.js",
    "data-loader": "./js/modules/infra/persistence/data-loader.js",
    "import-export": "./js/modules/infra/persistence/import-export.js",

    "battle-core": "./js/modules/domain/battle/battle-core.js",
    "action-execution": "./js/modules/domain/battle/action-execution.js",
    "hp-status": "./js/modules/domain/battle/hp-status.js",
    "targeting": "./js/modules/domain/battle/targeting.js",
    "quick-dice": "./js/modules/domain/battle/quick-dice.js",

    "entity-crud": "./js/modules/domain/entities/entity-crud.js",
    "actor-viewer": "./js/modules/domain/entities/actor-viewer.js",
    "cr-adjustment": "./js/modules/domain/entities/cr-adjustment.js",
    "ui-toggles": "./js/modules/domain/entities/ui-toggles.js",

    "monster-groups": "./js/modules/domain/groups/monster-groups.js",

    "keyboard-shortcuts": "./js/modules/app/keyboard-shortcuts.js",

    "use-toasts": "./js/modules/composables/use-toasts.js",
    "use-computed": "./js/modules/composables/use-computed.js",
    "use-image-cropper": "./js/modules/composables/use-image-cropper.js",

    "image-cropper": "./js/modules/media/image-cropper.js"
  }
}
</script>

    <!-- 2. ä¸»æ¨¡å—å…¥å£ -->
    <script type="module" src="js/main.js"></script>

    <!-- 3. Service Worker æ³¨å†Œè„šæœ¬ -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }
    </script>

</body>

</html>

